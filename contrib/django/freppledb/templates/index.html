{% extends "admin/base_site_nav.html" %}
{% load i18n %}

{% block title %}frePPLe{% endblock %}
{% block content_title %}
<div class="row">
	<div class="col-xs-12">
	  <h1 style="float: left;">
	   {% trans "cockpit"|capfirst %}
	  </h1>
	  <h1 style="float: right;">
      <button class="btn btn-xs btn-primary" onclick="dashboard.customize()" data-toggle="tooltip" data-placement="bottom" data-original-title="{% trans 'customize'|capfirst|force_escape %}">
        <span class="fa fa-wrench fa-lg"></span>
      </button>
		  <button class="btn btn-xs btn-primary" onclick="grid.showBucket()" data-toggle="tooltip" data-placement="bottom" data-original-title="{% trans 'Configure time buckets'|escape %}">
		    <span class="fa fa-clock-o fa"></span>
		  </button>
	  </h1>
	</div>
</div>
{% endblock %}

{% block extrahead %}{{block.super}}
<script type="text/javascript" src="/static/js/d3.min.js"></script>
<script type="text/javascript" src="/static/js/jquery-ui-1.11.4.min.js"></script>
<script>
  $(function() {
    $(".cockpitcolumn").sortable({
      connectWith: ".cockpitcolumn",
      handle: ".panel-heading",
      cancel: ".panel-toggle",
      placeholder: "panel-placeholder"
    });
    $(".panel-toggle").click(function() {
      var icon = $(this);
      icon.toggleClass("fa-minus fa-plus");
      icon.closest(".panel").find(".panel-body").toggle();
    });
    $(".panel-close").click(function() {
      $(this).closest(".panel").remove();
      dashboard.save();
    });

    $("#horizonbucketsul li a").click(function(){
      $("#horizonbuckets1").html($(this).text() + '  <span class="caret"></span>');
      $("#horizonbuckets").val($(this).prop('name'));
    });

    $("#horizonunitul li a").click(function(){
      $("#horizonunit1").html($(this).text() + '  <span class="caret"></span>');
      $("#horizonunit").val($(this).prop('name'));
    });
  });
</script>
{% endblock %}

{% block content %}
{% getDashboard as dashboard hiddenwidgets %}
{% for row in dashboard %}
    <div class="row"><div class="col-md-6 col-sm-12 ui-sortable"><h1 style="float: left">{{ row.rowname }}</h1></div></div>
    <div class="row" id="{{ row.rowname }}">
				{% for cols in row.cols %}
				<div class="cockpitcolumn {{cols.width}}">
					  {% for widget in cols.widgets %}<div class="panel panel-default">
					  <div class="panel-heading" data-toggle="tooltip" data-placement="top" title="{{widget.tooltip|escape}}">
						    <span class='fa fa-times pull-right panel-close'></span>
						    <span class='fa fa-minus pull-right panel-toggle'></span>
						    {% if widget.exporturl %}<a href="{{request.prefix}}{{widget.url}}&amp;format=spreadsheet"><span class='fa fa-arrow-down pull-right portlet-export'></span></a>{% endif %}
						    {% if widget.url %}<a href="{{request.prefix}}{{widget.url}}">{{widget.title|upper}}</a>{% else %}{{widget.title|upper}}{% endif %}
					  </div>
					  <div class="panel-body">{% if widget.asynchronous %}<div id="widget_{{widget.name}}" style="text-align:center"><img src="{{STATIC_URL}}img/loading.gif" height="32" alt="loading"></div>{% else %}{{widget.render|safe}}{% endif %}</div>
					  </div>
					  {% endfor %}
				</div>
		    {% endfor %}
    </div>
{% endfor %}

{% for row in dashboard %}
		{% for col in row.cols %}{% if forloop.first %}<script>{% endif %}
				{% for widget in col.widgets %}
			     {% if widget.asynchronous %}$.ajax({
				      url: "{{request.prefix}}/widget/{{widget.name}}/{{widget.args}}",
				      type: "GET",
				      success: function (data) {
				        $("#widget_{{widget.name}}").parent().html(data);
				        {{widget.javascript|safe}}
				        },
				      error: function (result, stat, errorThrown) {
				        $("#widget_{{widget.name}}").parent().html("{% trans "failed"|capfirst %}");
				        }
				    });
				  {% else %}{{widget.javascript|safe}}
				  {% endif %}
				{% endfor %}
				{% if forloop.last %}</script>{% endif %}
		{% endfor %}
{% endfor %}

<div  id="timebuckets" class="modal fade" role="dialog" aria-labelledby="timebucketsLabel" style="padding-right: 0px;">
  <div class="modal-dialog">
    <div class="modal-content" style="width: 500px;">
    <form method="get" action="#">

      <div class="modal-header">
       <h4 class="modal-title">{% trans 'time buckets'|capfirst %}</h4>
      </div>
      <div class="modal-body">

      <form method="get" action="#">
      <input type="hidden" name="horizonbuckets" id="horizonbuckets" value="{{request.user.horizonbuckets}}">
      <input type="hidden" name="horizonunit" id="horizonunit" value="{{request.user.horizonunit}}">
      <input id="horizonoriginal" type="hidden" value="{{request.user.horizonbuckets}}|{{request.user.horizonstart|date:"Y-m-d"}}|{{request.user.horizonend|date:"Y-m-d"}}|{{request.user.horizontype}}|{{request.user.horizonlength}}|{{request.user.horizonunit}}"/>
          <div class="row" style="padding-bottom: 15px">
            <div class="col-xs-12">
              {% trans 'bucket size'|capfirst %}&nbsp;&nbsp;
              <div class="dropdown dropdown-submit-input" style="display:inline">
                  <button class="btn btn-default dropdown-toggle" type="button" name="horizonbuckets1" id="horizonbuckets1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    {% if request.user.horizonbuckets %}{% trans request.user.horizonbuckets %}{% endif %}&nbsp;&nbsp;<span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="horizonbuckets1" id="horizonbucketsul" name="horizonbucketsul" style="top: auto;">
                  {% for i in bucketnames %}
                    <li><a onclick="" name="{{ i }}">{% trans i %}</a></li>
                  {% endfor %}
                  </ul>
              </div>
            </div>
          </div>

          <div class="row" style="padding-bottom: 15px">
            <div class="col-xs-12 form-inline">
              <input type="radio" name="horizontype" value="0"{% if not request.user.horizontype %} checked{% endif %}/>
              &nbsp;&nbsp;{% trans 'from'|capfirst %}&nbsp;
              <input id="horizonstart"  style="display:inline" type="text" size="9" class="vDateField form-control" value="{{request.user.horizonstart|date:"Y-m-d"}}"/>
              &nbsp;{% trans 'to' %}&nbsp;
              <input id="horizonend"  style="display:inline" type="text" size="9" class="vDateField form-control" value="{{request.user.horizonend|date:"Y-m-d"}}"/>
              <br/>
           </div>
          </div>

          <div class="row">
            <div class="col-xs-12 form-inline">
              <input type="radio" id="horizontype" name="horizontype" value="1"{% if request.user.horizontype %} checked{% endif %}/>&nbsp;&nbsp;
              <input id="horizonlength" name="horizonlength" type="number" class="form-control" min="1" max="99" maxlength="2" value="{{request.user.horizonlength}}"/>&nbsp;
              <div class="dropdown dropdown-submit-input" style="display:inline">
                <button class="btn btn-default dropdown-toggle form-control" type="button" name="horizonunit1" id="horizonunit1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                  {% if request.user.horizonunit == "day" %}{% trans 'days' %}{% endif %}
                  {% if request.user.horizonunit == "week" %}{% trans 'weeks' %}{% endif %}
                  {% if request.user.horizonunit == "month" %}{% trans 'months' %}{% endif %}
                  &nbsp;&nbsp;<span class="caret"></span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="horizonunit1" id="horizonunitul" name="horizonunitul" style="top: auto;">
                  <li><a name="day">{% trans 'days' %}</a></li>
                  <li><a name="week">{% trans 'weeks' %}</a></li>
                  <li><a name="month">{% trans 'months' %}</a></li>
                </ul>
              </div>
              &nbsp;{% trans 'after plan current date' %}
            </div>
          </div>
      </form>

      </div>
      <div class="modal-footer">
        <input type="submit" id="okbutton" role="button" class="btn btn-primary pull-left" value="{% trans 'OK' %}">
        <input type="submit" id="cancelbutton" role="button" class="btn btn-primary pull-right" data-dismiss="modal" value="{% trans 'cancel'|capfirst %}">
      </div>
    </div>
  </div>
</div>

<script>
var hiddenwidgets = [
{% for key, value in hiddenwidgets.items%}{% if not forloop.first %},
{% endif %}  ["{{key|escapejs}}","{{value.title|escapejs}}"]{% endfor %}
];
</script>
{% endblock %}
