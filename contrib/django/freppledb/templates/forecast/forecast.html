{% extends "admin/base_site_gridpivot.html" %}
{% load i18n %}

{% block extrahead %}{{block.super}}
{% if mode == "graph" %}<script type="text/javascript">
$(function(){ graph.header(); })
</script>{% endif %}
{% endblock %}

{% block contextmenus %}
{% include "itemcontext.html" %}
{% include "forecastcontext.html" %}
{% include "customercontext.html" %}
<div id="detailcontext" class="ContextMenu"><ul class="ui-menu ui-widget ui-widget-content ui-corner-all ui-state-default">
<li class="ui-menu-item"><a id="{{request.prefix}}/demandplan/?demand__startswith={value}&amp;o=5a&amp;plandate__gte={startdate}&amp;plandate__lt={enddate}">{% trans 'Detail' %}</a></li>
</ul></div>
{% if mode == "graph" %}<div id="tooltip" role="tooltip" class="ui-tooltip ui-widget ui-corner-all ui-widget-content" style="display: none; position: absolute;"/>
{% endif %}{% endblock %}

{% block tools %}{% if args.0 %}
{% include "forecasttabs.html" %}
{% endif %}{{block.super}}
{% endblock %}

{% block before_table %}{% if args.0 %}
<div id="graph" style="clear: both; height: 400px; padding: 10px; "></div>
{% endif %}{% endblock %}

{% block crosses %}
{% if args.0 %}$(function(){
  // Resize top graph
  var h = $(window).height();
  $("#graph").width($(window).width()-55).height(h>800 || h<480 ? 400 : h-380);
});{% endif %}

{% if args.0 or mode == "graph" %}
function drawGraphs(jsondata)
{
  {% if args.0 %}var margin = {top: 0, right: 100, bottom: 30, left: 50};
  {% else %}var margin = {top: 0, right: 0, bottom: 0, left: 50};
  {% endif %}var width = $({% if args.0 %}"#graph"{% else %}"#grid_graph"{% endif %}).width() - margin.left - margin.right;
  var height = {% if args.0 %}$("#graph").height(){% else %}80{% endif %} - margin.top - margin.bottom;

  // Lookup table of displayed columns
  var fields = {};
  for (var i in cross_idx)
    fields[cross_idx[i]] = 0;

  // Define X-axis
  var domain_x = [];
  var bucketnamelength = 0;
  for (var i in timebuckets)
  {
    domain_x.push(timebuckets[i]['name']);
    bucketnamelength = Math.max(timebuckets[i]['name'].length, bucketnamelength);
  }
  var x = d3.scale.ordinal()
    .domain(domain_x)
    .rangeRoundBands([0, width], .1);
  var x_width = x.rangeBand();

  // Define Y-axis
  var y = d3.scale.linear().rangeRound([height, 0]);

  // Draw all graphs
  $("#grid"){% if not args.0 %}.find(".graph"){% endif %}.each(function(index)
  {
    // Create a new SVG element
    $({% if args.0 %}$("#graph").get(0){% else %}this{% endif %}).html("");
    var svg = d3.select({% if args.0 %}$("#graph").get(0){% else %}this{% endif %})
      .append("svg")
      .attr("class","graphcell")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Build the data for d3
    var max_y = 0;
    var min_y = 0;
    var data = [];
    for (var bckt in timebuckets)
    {
      var tmp = jsondata['rows'][index][timebuckets[bckt]['name']];
      data.push({
        'forecast': jsondata['rows'][index]['forecast'],
        'bucket': bckt,
        'orderstotal': tmp[0],
        'ordersopen': tmp[1],
        'ordersadjustment': tmp[2],
        'forecastbaseline': tmp[3],
        'forecastadjustment': tmp[4],
        'forecasttotal': tmp[5],
        'forecastnet': tmp[6],
        'forecastconsumed': tmp[7],
        'ordersplanned': tmp[8],
        'forecastplanned': tmp[9],
        'past': tmp[10],
        'future': tmp[11],
        });
      if (tmp[5] > max_y && 5 in fields)
         max_y = tmp[5];
      if (tmp[0] > max_y && 0 in fields)
        max_y = tmp[0];
      if (tmp[8] + tmp[9] > max_y && 8 in fields && 9 in fields)
        max_y = tmp[8] + tmp[9];
      else if (tmp[8] > max_y && 8 in fields)
        max_y = tmp[8];
      else if (tmp[9] > max_y && 9 in fields)
        max_y = tmp[9];
    }

    // Update the scale of the Y-axis by looking for the max value
    y.domain([min_y,max_y]);
    var y_zero = y(0);

    // Create D3 bars
    var my_y;
    svg.selectAll("g")
      .data(data)
      .enter()
      .append("g")
      .attr("transform", function(d) { return "translate(" + x(timebuckets[d['bucket']]['name']) + ",0)"; })
      .on("click", function(d) {
          if (d3.event.defaultPrevented || (d['produced'] == 0 && d['consumed'] == 0))
            return;
          d3.select("#tooltip").style('display', 'none');
          contextMenu = $("#detail2context");
          contextMenu.find('a').each( function() {
              $(this).attr(
                'href',
                $(this).attr('id')
                  .replace(/{value}/g, admin_escape(d['buffer']))
                  .replace(/{enddate}/g, timebuckets[d['bucket']]['enddate'])
                  .replace(/{startdate}/g, timebuckets[d['bucket']]['startdate'])
                );
            });
          var coord = d3.mouse(document.body);
          contextMenu.css({
            left: coord[0],
            top: coord[1],
            display: 'block'
            });
          d3.event.stopPropagation();
        })
      .on("mouseenter", function(d) {
         graph.showTooltip(
           '<div style="text-align:center; font-weight:bold">'
           + timebuckets[d['bucket']]['name'] + '</div>'
           + '<table><tr><td>{{_('total orders')|capfirst}}</td><td style="text-align:right">'
           + (Math.round(d['orderstotal']*10)/10)
           + '</td></tr><tr><td>{{_('open orders')|capfirst}}</td><td style="text-align:right">'
           + (Math.round(d['ordersopen']*10)/10)
           + '</td></tr><tr><td>{{_('orders adjustment')|capfirst}}</td><td style="text-align:right">'
           + (Math.round(d['ordersadjustment']*10)/10)
           + '</td></tr><tr><td>{{_('forecast baseline')|capfirst}}</td><td style="text-align:right">'
           + (Math.round((d['forecastbaseline'])*10)/10)
           + '</td></tr><tr><td>{{_('forecast adjustment')|capfirst}}</td><td style="text-align:right">'
           + (Math.round((d['forecastadjustment'])*10)/10)
           + '</td></tr><tr><td>{{_('forecast total')|capfirst}}</td><td style="text-align:right">'
           + (Math.round((d['forecasttotal'])*10)/10)
           + '</td></tr><tr><td>{{_('forecast net')|capfirst}}</td><td style="text-align:right">'
           + (Math.round((d['forecastnet'])*10)/10)
           + '</td></tr><tr><td>{{_('forecast consumed')|capfirst}}</td><td style="text-align:right">'
           + (Math.round((d['forecastconsumed'])*10)/10)
           + '</td></tr><tr><td>{{_('planned orders')|capfirst}}</td><td style="text-align:right">'
           + (Math.round((d['ordersplanned'])*10)/10)
           + '</td></tr><tr><td>{{_('planned net forecast')|capfirst}}</td><td style="text-align:right">'
           + (Math.round((d['forecastplanned'])*10)/10)
           + '</td></tr></table>'
           );
        })
      .on("mouseleave", graph.hideTooltip)
      .on("mousemove", graph.moveTooltip)
      .each(function(d) {
        var bucket = d3.select(this);
        var top;
        if (d['ordersopen'] > 0 && 1 in fields)
        {
          my_y = y(d['ordersopen']);
          bucket.append("rect")
            .attr("width", x_width/2)
            .attr("height", y_zero - my_y)
            .attr("x", x_width/2)
            .attr("y", my_y)
            .style("fill","#2B95EC");
        }
        if (d['ordersplanned'] > 0 && 8 in fields)
        {
          top = y(d['ordersplanned']);
          bucket.append("rect")
            .attr("width", x_width/2)
            .attr("y", top)
            .attr("height", y_zero - top)
            .style("fill","#7B5E08");
        }
        if (d['forecastplanned'] > 0 && 9 in fields)
        {
          bucket.append("rect")
            .attr("width", x_width/2)
            .attr("y", y(d['forecastplanned'] + d['ordersplanned']))
            .attr("height", y(d['ordersplanned']) - y(d['forecastplanned'] + d['ordersplanned']))
            .style("fill","#F6BD0F");
        }
      });

    // Create D3 lines
    if (0 in fields)
    {
      var line = d3.svg.line()
        .x(function(d) { return x(timebuckets[d['bucket']]['name']) + x_width / 2; })
        .y(function(d) { return y(d['orderstotal']); });
      svg.append("svg:path")
        .attr('class', 'graphline')
        .attr("stroke","#8BBA00")
        .attr("d", line(data));
    }
    if (5 in fields)
    {
      var line = d3.svg.line()
        .x(function(d) { return x(timebuckets[d['bucket']]['name']) + x_width / 2; })
        .y(function(d) { return d['future']==1 ? y(d['forecasttotal']) : y_zero; });
      svg.append("svg:path")
        .attr('class', 'graphline')
        .attr("stroke","#FF0000")
        .attr("d", line(data));
    }

    // Display Y-Axis
    var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");
    {% if not args.0 %}
    svg.append("g")
      .attr("class", "miniaxis")
      .call(graph.miniAxis.bind(yAxis));
    {% else %}
    svg.append("g")
      .attr("class", "y axis")
      .call(yAxis);

    // Display X-axis for a single forecast
    var nth = Math.ceil(timebuckets.length / width * bucketnamelength * 10);
    var myticks = [];
    for (var i in timebuckets)
      if (i % nth == 0) myticks.push(timebuckets[i]['name']);
    var xAxis = d3.svg.axis()
      .scale(x)
      .tickValues(myticks)
      .orient("bottom");
    svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

    // Display legend
    var legend = svg.append("g");
    var codes = [
      ["{{_('open orders')|capfirst}}", "#2B95EC", 1],
      ["{{_('total orders')|capfirst}}", "#8BBA00", 0],
      ["{{_('forecast total')|capfirst}}", "#FF0000", 5],
      ["{{_('planned orders')|capfirst}}", "#7B5E08", 8],
      ["{{_('planned net forecast')|capfirst}}", "#F6BD0F", 9]
      ];
    var visible = 0;
    for (var i in codes)
    {
      if (!(codes[i][2] in fields))
        continue;
      legend.append("rect")
        .attr("x", width + 82)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", codes[i][1])
        .attr("transform", "translate(0," + (visible*20+10) + ")");
      legend.append("text")
        .attr("x", width + 76)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
        .text(codes[i][0])
        .attr("transform", "translate(0," + (visible*20+10) + ")");
      visible += 1;
    }{% endif %}
    });
}
{% endif %}
{% if args.0 or mode == "table" %}
function getDirtyData()
{
  var changes = [];
  $(".dirty-cell").each( function() {
    var curCol = jQuery.jgrid.getCellIndex($(this).closest("td,th"));
    var curRow = $(this).closest("tr").attr('id');
    var colmodel = jQuery("#grid").jqGrid ('getGridParam', 'colModel')[curCol];
    if ($(this).hasClass('adjhistory'))
      changes.push({'id': curRow, 'startdate': colmodel['startdate'], 'enddate': colmodel['enddate'], 'adjHistory': $(this).val()});
    else
      changes.push({'id': curRow, 'startdate': colmodel['startdate'], 'enddate': colmodel['enddate'], 'adjForecast': $(this).val()});
    });
  return changes;
}

function onChange(event)
{
  $(event.target).addClass('dirty-cell');
  upload.select();
}

function crosses (cellvalue, options, rowdata)
{
  var result = '';
  for (var i in cross_idx)
    switch(cross_idx[i])
    {
      case 0: // Total orders
      case 1: // Open orders
        if (cellvalue[cross_idx[i]] != 0.0)
          result += cellvalue[cross_idx[i]] + "<span class='context cross ui-icon ui-icon-triangle-1-e' role='detail'></span></br>";
        else
          result += '0.0</br>';
        break;
      case 2: // Orders adjustment{% if perms.forecast.change_forecastdemand %}
        if (cellvalue[10] == 1)
          result += '<input type="text" class="smallpadding adjhistory" value="' + Math.round(cellvalue[2]) + '" size="5" onchange="onChange(event)" onclick="$(this).select();"/><br/>';
        else
          result += '<br/>';
        {% else %}
        result += Math.round(cellvalue[2]) + '<br/>';{% endif %}
        break;
      case 3: // Baseline forecast
        if (cellvalue[11] == 1)
          result += (Math.round(cellvalue[3]*10)/10) + '<br/>';
        else
          result += '<br/>';
        break;
      case 4: // Forecast adjustment{% if perms.forecast.change_forecastdemand %}
        if (cellvalue[11] == 1)
          result += '<input type="text" class="smallpadding adjforecast" value="' + (Math.round(cellvalue[4]*10)/10) + '" size="5" onchange="onChange(event)" onclick="$(this).select();"/><br/>';
        else
          result += '<br/>';
        {% else %}
        if (cellvalue[11] == 1)
          result += (Math.round(cellvalue[4]*10)/10) + '<br/>';
        else
        result += '<br/>';{% endif %}
        break;
      case 5: // Forecast total
      case 6: // Forecast net
      case 7: // Forecast consumed
        if (cellvalue[11] == 1)
          result += (Math.round(cellvalue[cross_idx[i]]*10)/10) + "<br/>";
        else
          result += '<br/>';
        break;
      case 8: // Orders planned
      case 9: // Forecast planned
        if (cellvalue[11] == 1)
        {
          if (cellvalue[cross_idx[i]] != 0.0)
            result += (Math.round(cellvalue[cross_idx[i]]*10)/10) + "<span class='context cross ui-icon ui-icon-triangle-1-e' role='detail'></span><br/>";
          else
            result += '0<br/>';
        }
        else
          result += '<br/>';
    }
  return result;
};
{% endif %}{% endblock %}

{% block extra_grid %}{% if args.0 or mode == "graph" %}loadComplete: drawGraphs,
{% endif %}{% endblock %}
