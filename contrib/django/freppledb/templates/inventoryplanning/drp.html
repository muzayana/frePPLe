{% extends "admin/base_site_grid.html" %}
{% load i18n %}

{% block extra_grid %}onSelectRow: selectRow,
{% if preferences.grouping == 'item' or preferences.grouping == 'location' %}
  grouping:true,
  groupingView : {
	  groupField : ['{{preferences.grouping}}'],
	  groupSummary : [true],
	  groupColumnShow : [true],
	  groupSummaryPos: ['header'],
	  groupDataSorted : true,
	  groupText : ['<b>{0}</b>'],
	  groupCollapse : {% if args %}false{% else %}true{% endif %},
	  hideFirstGroupCol: false,
	  showSummaryOnHide: true
  },{% endif %}
{% endblock %}


{% block extrahead %}{{block.super}}
<script type="text/javascript" src="{{STATIC_URL}}js/d3.min.js"></script>
<script type="text/javascript">

var showtab = null;
var result = null;
var current_date = new Date('{{request.current_date}}');
var bucketsize = '{{request.report_bucket}}';
var forecastcurrentbucket = 0;
var units = '{% if not "units" in preferences or preferences.units == 'units' %}units{% else %}value{% endif %}';
var timebuckets = [ {% for f in request.report_bucketlist %}{% if not forloop.first %},{% endif %}{'name':'{{f.name}}','startdate':'{{f.startdate|date:"Y-m-d"}}','enddate':'{{f.enddate|date:"Y-m-d"}}'}{% endfor %} ];


function selectRow(id)
{
  if (!!result && id == result.name)
    // Selection has not changed
    return;

  if ($('#save').hasClass("save_undo_button_active"))
  {
    // Warn about unsaved changes
    $('#popup')
      .html("{% trans 'Do you want to save your changes first?'|escapejs %}")
      .dialog({
        title: gettext("Unsaved changes"),
        autoOpen: true,
        resizable: false,
        width: 'auto',
        height: 'auto',
        buttons : {
            {% comment %}Translators: Translation included with Django {% endcomment %}
            "{% filter escapejs %}{% trans "Save" %}{% endfilter %}" : function() {
              $(this).dialog("close");
              save(false);
              selectRow(id);
            },
            {% comment %}Translators: Translation included with Django {% endcomment %}
            "{% trans "No"|capfirst|escapejs %}" : function() {
              $('#undo, #recalculate, #save').addClass("save_undo_button_inactive").removeClass("save_undo_button_active");
              selectRow(id);
              $(this).dialog("close");
            }
          }
      });
    return;
  }

  $.ajax({
    url: '{{request.prefix}}/inventoryplanning/drpitemlocation/' + admin_escape(id) + '/',
    type: 'GET',
    success: function (r) {
      result = r;
      displayResult(true);
    },
    error: function (result, stat, errorThrown) {
      $('#popup').html(result.responseText + "  " + stat + errorThrown).dialog({
        title: gettext("Error retrieving data"),
        autoOpen: true,
        resizable: false,
        width: 'auto',
        height: 'auto'
      });
      }
    });

  $('#undo').addClass("save_undo_button_inactive").removeClass("save_undo_button_active");
  $('#save').addClass("save_undo_button_inactive").removeClass("save_undo_button_active");
  $("#actions")
  .addClass("ui-selectmenu-disabled ui-state-disabled change_status_selectmenu_inactive")
  .removeClass("change_status_selectmenu_active ui-state-enabled ui-selectmenu-enabled")
  .prop('disabled', 'disabled');
}


function clickNoStock()
{
	// Verify if different from current value
	if (result && (
		(result.parameters.nostock == 'True' && $("#nostock").prop('checked'))
		|| (result.parameters.nostock != 'True' && !$("#nostock").prop('checked'))
		))
  {
		// Same value as received from server
		$(this).removeClass('dirty-cell');
	  $('label[for=nostock]').removeClass('red');
  }
	else
	{
		activateSaveUndo();
	  $(this).addClass('dirty-cell');
	  $('label[for=nostock]').addClass('red');
	}
}


function clickROQtype()
{
	var sel = $('input[name="roq_type"]:checked');
	$('label[for=roq_type_calculated], label[for=roq_type_quantity], label[for=roq_type_periodofcover]').removeClass('red');
	if (result && sel.val() == result.parameters.roq_type)
		// Same value as received from server
		$('label[for=' + sel.attr('id') + ']').removeClass('red');
	else
	{
	  // Different value
		$('label[for=' + sel.attr('id') + ']').addClass('red');
	  activateSaveUndo();
	}
}


function clickSStype()
{
  var sel = $('input[name="ss_type"]:checked');
  $('label[for=ss_type_calculated], label[for=ss_type_quantity], label[for=ss_type_periodofcover]').removeClass('red');
  if (result && sel.val() == result.parameters.ss_type)
    // Same value as received from server
    $('label[for=' + sel.attr('id') + ']').removeClass('red');
  else
  {
	  // Different value
    $('label[for=' + sel.attr('id') + ']').addClass('red');
    activateSaveUndo();
  }
}


function extraPreference()
{
  // TODO save settings on forecast, planning and transaction tabs
  return {
    "height": Math.round($("#gbox_grid").height() - 48),
    "showtab": showtab,
    "type": result ? result.type : null,
    "name": result ? result.name : null,
    "units": units,
    "grouping": $("#grouping").val()
  };
}

function select()
{
  $('#save').removeClass("save_undo_button_inactive").addClass("save_undo_button_active");
  $('#undo').removeClass("save_undo_button_inactive").addClass("save_undo_button_active");
  $(window).off('beforeunload', warnUnsavedChanges);
  $(window).on('beforeunload', warnUnsavedChanges);
}

function activateSaveUndo()
{
  $('#save, #recalculate, #undo').removeClass("save_undo_button_inactive").addClass("save_undo_button_active");
  $(window).off('beforeunload', warnUnsavedChanges);
  $(window).on('beforeunload', warnUnsavedChanges);
}

function warnUnsavedChanges() {
  return gettext("There are unsaved changes on this page.");
}

function onChange(event) {
  $(event.target).addClass('dirty-cell');
  select();
}

function undo() {
  // Reset the buttons
  $('#undo, #save, #recalculate').addClass("save_undo_button_inactive").removeClass("save_undo_button_active");
  $("#actions").addClass("ui-selectmenu-disabled ui-state-disabled change_status_selectmenu_inactive")
    .removeClass("change_status_selectmenu_active ui-state-enabled ui-selectmenu-enabled")
    .prop('disabled', 'disabled');
  $(window).off('beforeunload', warnUnsavedChanges);
  var entity = result.name;
  result = null;
  selectRow(entity); //Fetch data & redraw
}

function select() {
  $('#filter').addClass("ui-state-disabled");
  $.jgrid.hideModal("#searchmodfbox_grid");
  $('#save, #undo, #recalculate').removeClass("save_undo_button_inactive").addClass("save_undo_button_active");
  $(window).off('beforeunload', warnUnsavedChanges);
  $(window).on('beforeunload', warnUnsavedChanges);
}


function markSelectedRow(id)
{
  var sel = jQuery("#transactiongrid").jqGrid('getGridParam','selarrrow').length;
  if (sel > 0)
  {
    $("#actions").removeClass("ui-selectmenu-disabled ui-state-disabled change_status_selectmenu_inactive")
    .addClass("change_status_selectmenu_active ui-state-enabled ui-selectmenu-enabled")
    .prop('disabled', false);
  }
  else
  {
    $("#actions")
    .addClass("ui-selectmenu-disabled ui-state-disabled change_status_selectmenu_inactive")
    .removeClass("change_status_selectmenu_active ui-state-enabled ui-selectmenu-enabled")
    .prop('disabled', 'disabled');
  }
}


function changeGrouping()
{
  grid.saveColumnConfiguration();
  setTimeout(function() { window.location.href = window.location.href; }, 1000);
}


function changeUnits(newval)
{
  if (units == newval)
    return; // Nothing changed
  units = newval;
  grid.saveColumnConfiguration();
  setTimeout(function() { window.location.href = window.location.href; }, 1000);
}


function setStatus(newstatus)
{
  var sel = jQuery("#transactiongrid").jqGrid('getGridParam','selarrrow');
  for ( i in sel ) {
    jQuery("#transactiongrid").jqGrid("setCell", sel[i], "status", newstatus, "dirty-cell");
    jQuery("#transactiongrid").jqGrid("setRowData", sel[i], false, "edited");
  };

  $("#actions").prop("selectedIndex",0);
  $('#save, #undo').removeClass("save_undo_button_inactive").addClass("save_undo_button_active");
  $(window).on('beforeunload', warnUnsavedChanges);
}

{% if perms.forecast.change_forecast %}
function setForecastMethod(newmethod)
{
  $('#save, #undo, #recalculate').removeClass("save_undo_button_inactive").addClass("save_undo_button_active");
  $('#forecastmethod').addClass('dirty-cell red');
  $(window).on('beforeunload', warnUnsavedChanges);
}
{% endif %}


function reapplyChanges(data)
{
	// Apply the changes to the grids.
	// Fields outside the grids aren't updated, so we don't need to reapply any changes on them.

	{% if perms.forecast.change_forecastdemand %}// Get forecast data changes
	if ("forecast" in data) {
		for (var fcstchange in data["forecast"])
		{
			var cell = $('td[aria-describedby="forecastgrid_' + data["forecast"][fcstchange].bucket + '"');
      if ("adjHistory1" in data["forecast"][fcstchange])
          cell.find("input.adjhistory-1").addClass("dirty-cell");
      if ("adjHistory2" in data["forecast"][fcstchange])
          cell.find("input.adjhistory-2").addClass("dirty-cell");
      if ("adjHistory3" in data["forecast"][fcstchange])
          cell.find("input.adjhistory-3").addClass("dirty-cell");
      if ("adjForecast" in data["forecast"][fcstchange])
          cell.find("input.adjforecast").addClass("dirty-cell");
		}
	}
  {% endif %}

  {% if perms.input.change_calendarbucket %}// Get inventory override changes
  if ("plan" in data) {
    for (var planchange in data["plan"])
    {
      var cell = $('td[aria-describedby="plangrid_' + data["plan"][planchange].bucket + '"');
      if ("roqoverride" in data["plan"][planchange])
        cell.find("input.roqoverride").addClass("dirty-cell");
      if ("ssoverride" in data["plan"][planchange])
        cell.find("input.ssoverride").addClass("dirty-cell");
    }
  }
  {% endif %}
}


function collectChanges() {
  // Build the results to send back to the server
  var data = {};

  {% if perms.common.add_comment %}
  // Get a new entered comment
  $("#commentitemlocation.comment_button_active").each(function() {
    data["comment"] = $("#newcomment").val();
    data["commenttype"] = "itemlocation";
    });
  $("#commentlocation.comment_button_active").each(function() {
    data["comment"] = $("#newcomment").val();
    data["commenttype"] = "location";
    });
  $("#commentitem.comment_button_active").each(function() {
    data["comment"] = $("#newcomment").val();
    data["commenttype"] = "item";
    });
  {% endif %}

  {% if perms.forecast.change_forecastdemand %}// Get forecast data changes
  var fcstchanges = [];
  $("#forecastgrid .dirty-cell").each( function() {
     var curCol = jQuery.jgrid.getCellIndex($(this).closest("td,th"));
     var curRow = $(this).closest("tr").attr('id');
     var colmodel = jQuery("#forecastgrid").jqGrid ('getGridParam', 'colModel')[curCol];
     if ($(this).hasClass('adjhistory-3'))
       fcstchanges.push({
          'startdate': colmodel['startdate'], 'enddate': colmodel['enddate'], 'adjHistory3': $(this).val(), 'bucket': colmodel['name']
          });
     else if ($(this).hasClass('adjhistory-2'))
       fcstchanges.push({
         'startdate': colmodel['startdate'], 'enddate': colmodel['enddate'], 'adjHistory2': $(this).val(), 'bucket': colmodel['name']
         });
     else if ($(this).hasClass('adjhistory-1'))
       fcstchanges.push({
         'startdate': colmodel['startdate'], 'enddate': colmodel['enddate'], 'adjHistory1': $(this).val(), 'bucket': colmodel['name']
         });
     else if ($(this).hasClass('adjforecast'))
       fcstchanges.push({
         'startdate': colmodel['startdate'], 'enddate': colmodel['enddate'], 'adjForecast': $(this).val(), 'bucket': colmodel['name']
         });
  });
  if (!$.isEmptyObject(fcstchanges))
    data["forecast"] = fcstchanges;
  {% endif %}

  {% if perms.input.change_calendarbucket %}// Get inventory override changes
  var planchanges = [];
  $("#plangrid .dirty-cell").each( function() {
     var curCol = jQuery.jgrid.getCellIndex($(this).closest("td,th"));
     var curRow = $(this).closest("tr").attr('id');
     var colmodel = jQuery("#plangrid").jqGrid ('getGridParam', 'colModel')[curCol];
     if ($(this).hasClass('roqoverride'))
       planchanges.push({
          'startdate': colmodel['startdate'], 'enddate': colmodel['enddate'], 'roqoverride': $(this).val(), 'bucket': colmodel['name']
          });
     if ($(this).hasClass('ssoverride'))
       planchanges.push({
         'startdate': colmodel['startdate'], 'enddate': colmodel['enddate'], 'ssoverride': $(this).val(), 'bucket': colmodel['name']
         });
  });
  if (!$.isEmptyObject(planchanges))
    data["plan"] = planchanges;
  {% endif %}

  {% if perms.input.change_purchaseorder or perms.input.change_distributionorder %}
  // Get transaction changes
  var transchange = [];
  $("#transactiongrid .dirty-cell").each( function() {
    // Verify if this id is already added into the grid
    var curRow = $(this).closest("tr").attr('id');
    var found = false;
    for (var chck in transchange)
      if (transchange[chck].id == curRow)
        found = true;
    if (!found)
      transchange.push(
        jQuery("#transactiongrid").jqGrid('getRowData', curRow)
        );
  });
  if (!$.isEmptyObject(transchange))
    data["transactions"] = transchange;
  {% endif %}

  {% if perms.inventoryplanning.change_inventoryplanning or perms.forecast.change_forecast %}
  // Get inventory planning and forecast parameter changes
  var prmtr = {};
  {% if perms.inventoryplanning.change_inventoryplanning %}
  var tmp = $('input[name="roq_type"]:checked');
  if ($("label[for=" + tmp.attr('id') + "]").hasClass('red'))
	  result.parameters['roq_type'] = prmtr["roq_type"] = $('input[name="roq_type"]:checked').val();
	if ($("#roq_min_qty").hasClass('dirty-cell'))
		result.parameters['roq_min_qty'] = prmtr["roq_min_qty"] = $("#roq_min_qty").val();
	if ($("#roq_min_poc").hasClass('dirty-cell'))
		result.parameters['roq_min_poc'] = prmtr["roq_min_poc"] = $("#roq_min_poc").val();
	if ($("#service_level").hasClass('dirty-cell'))
		result.parameters['service_level'] = prmtr["service_level"] = $("#service_level").val();
	if ($("#demand_deviation").hasClass('dirty-cell'))
		result.parameters['demand_deviation'] = prmtr["demand_deviation"] = $("#demand_deviation").val();
	if ($("#leadtime_deviation").hasClass('dirty-cell'))
		result.parameters['leadtime_deviation'] = prmtr["leadtime_deviation"] = $("#leadtime_deviation").val();
  var tmp = $('input[name="ss_type"]:checked');
	if ($("label[for=" + tmp.attr('id') + "]").hasClass('red'))
		result.parameters['ss_type'] = prmtr["ss_type"] = $('input[name="ss_type"]:checked').val();
  if ($("#ss_min_qty").hasClass('dirty-cell'))
	  result.parameters['ss_min_qty'] = prmtr["ss_min_qty"] = $("#ss_min_qty").val();
  if ($("#ss_min_poc").hasClass('dirty-cell'))
	  result.parameters['ss_min_poc'] = prmtr["ss_min_poc"] = $("#ss_min_poc").val();
  if ($("label[for=nostock]").hasClass('red'))
	  result.parameters['nostock'] = prmtr["nostock"] = $("#nostock").prop('checked');
  {% endif %}
  {% if perms.forecast.change_forecast %}
  if ($("#forecastmethod").hasClass('red'))
	  result.parameters['forecastmethod'] = prmtr["forecastmethod"] = $("#forecastmethod").val();
  {% endif %}
  if (!$.isEmptyObject(prmtr))
    data["parameters"] = prmtr;
  {% endif %}
  return data;
}


function save(simulate)
{
  if (result == null)
    return;
	var data = collectChanges();

  // Send the results back to the server
  if (!$.isEmptyObject(data)) {
	  data['simulate'] = simulate
	  data['editvalue'] = result.displayvalue;
	  $.ajax({
	    url: '{{request.prefix}}/inventoryplanning/drpitemlocation/' + admin_escape(result.name) + '/',
	    type: 'POST',
	    data: JSON.stringify(data),
	    contentType: 'application/json',
	    success: function(newdata) {
	      if (simulate)
        {
          // We received simulation results from the server.
          // Merge the simulation results in the existing results (because the simulation returns
          // a subset of the results only).
          for (var i in newdata)
          {
            if (i == 'parameters')
              for (var j in newdata[i])
                result[i][j] = newdata[i][j];
            else
              result[i] = newdata[i];
          }
          // Populate the new results in the grid
          displayResult(false);
          // Apply the grid changes again, to make them show up in red
          reapplyChanges(data);
        }
        else
        {
		      // Reset the buttons
		      $('#undo, #recalculate, #save').addClass("save_undo_button_inactive").removeClass("save_undo_button_active");
		      $(window).off('beforeunload', warnUnsavedChanges);
	        // Refresh the detail pane from the server after successful save.
	        // TODO This could be optimized: the server could return the updated
	        // data immediately, rather than the client asking here for the new data.
	        var entity = result.name;
	        result = null;
	        selectRow(entity);
	      }
      },
	    error: function (result, stat, errorThrown) {
	      // Error message
	      $('#popup').html(result.responseText)
	        .dialog({
	        title: gettext("Error saving data"),
	        autoOpen: true,
	        resizable: false,
	        width: 'auto',
	        height: 'auto'
	      });
	      }
	    });
	  }
}


function forecastfields() {
  var col =
	{% if perms.forecast.change_forecastdemand %}
    '{{_("total orders 3 years ago")|capfirst}}<br/>' +
    '<span class="editablepivotcol">{{_("orders adjustment 3 years ago")|capfirst}}</span><br/>' +
    '{{_("total orders 2 years ago")|capfirst}}<br/>' +
    '<span class="editablepivotcol">{{_("orders adjustment 2 years ago")|capfirst}}</span><br/>' +
    '{{_("total orders 1 year ago")|capfirst}}<br/>' +
    '<span class="editablepivotcol">{{_("orders adjustment 1 year ago")|capfirst}}</span><br/>' +
    '{{_("total orders")|capfirst}}<br/>' +
    '{{_("open orders")|capfirst}}<br/>' +
    '<span class="bold">{{_("forecast baseline")|capfirst}}</span><br/>' +
    '<span class="editablepivotcol">{{_("forecast override")|capfirst}}</span><br/>';
  {% else %}
	  '{{_("total orders 3 years ago")|capfirst}}<br/>' +
	  '{{_("orders adjustment 3 years ago")|capfirst}}<br/>' +
	  '{{_("total orders 2 years ago")|capfirst}}<br/>' +
	  '{{_("orders adjustment 2 years ago")|capfirst}}<br/>' +
	  '{{_("total orders 1 year ago")|capfirst}}<br/>' +
	  '{{_("orders adjustment 1 year ago")|capfirst}}<br/>' +
	  '{{_("total orders")|capfirst}}<br/>' +
	  '{{_("open orders")|capfirst}}<br/>' +
	  '<span class="bold">{{_("forecast baseline")|capfirst}}</span><br/>' +
	  '{{_("forecast override")|capfirst}}<br/>';
  {% endif %}
  return col;
}


function planfields() {
  var col =
  {% if perms.input.change_calendarbucket %}
    '{{_("reorder quantity")|capfirst}}' + "<br/>" +
    '<span class="editablepivotcol">{{_("reorder quantity override")|capfirst}}</span><br/>' +
    '{{_("safety stock")|capfirst}}<br/>' +
    '<span class="editablepivotcol">{{_("safety stock override")|capfirst}}</span><br/>' +
    '{{_("starting inventory")|capfirst}}<br/>' +
    '{{_("local demand")|capfirst}}<br/>' +
    '{{_("dependent demand")|capfirst}}<br/>' +
    '<span class="bold">{{_("total demand")|capfirst}}</span><br/>' +
    '{{_("confirmed supply")|capfirst}}<br/>' +
    '{{_("proposed supply")|capfirst}}<br/>' +
    '<span class="bold">{{_("total supply")|capfirst}}</span><br/>' +
    '{{_("ending inventory")|capfirst}}<br/>';
  {% else %}
	  '{{_("reorder quantity")|capfirst}}' + "<br/>" +
	  '{{_("reorder quantity override")|capfirst}}<br/>' +
	  '{{_("safety stock")|capfirst}}<br/>' +
	  '{{_("safety stock override")|capfirst}}<br/>' +
	  '{{_("starting inventory")|capfirst}}<br/>' +
	  '{{_("local demand")|capfirst}}<br/>' +
	  '{{_("dependent demand")|capfirst}}<br/>' +
	  '<span class="bold">{{_("total demand")|capfirst}}</span><br/>' +
	  '{{_("confirmed supply")|capfirst}}<br/>' +
	  '{{_("proposed supply")|capfirst}}<br/>' +
	  '<span class="bold">{{_("total supply")|capfirst}}</span><br/>' +
	  '{{_("ending inventory")|capfirst}}<br/>';
  {% endif %}
  return col;
}


function forecastcell(cellvalue, options, rowObject) {
  var cell = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 1];
  if (!cell) return "";
  var cellstring = "";
  var currentbucketstart = new Date(timebuckets[0].startdate);
  var bucketdate = new Date(timebuckets[parseInt(options.pos) - 1].startdate);
  if (bucketdate - currentbucketstart >= 365 * 86400 * 1000)
  {
    // Beyond 1 year we don't show the order adjustment values
    {% if perms.forecast.change_forecastdemand %}
    cellstring += "<br><span class='editablepivotcol'></span><br><br><span class='editablepivotcol'></span><br><br><span class='editablepivotcol'></span><br>";
    {% else %}
    cellstring += "<br><br><br><br><br><br>";
    {% endif %}
  }
  else
  {
    // Show order adjustment values
    if (bucketsize == 'year')
    {
      var cell_min1 = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 2];
      var cell_min2 = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 3];
      var cell_min3 = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 4];
    }
    else if (bucketsize == 'quarter')
    {
      var cell_min1 = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 5];
      var cell_min2 = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 9];
      var cell_min3 = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 13];
    }
    else // Month
    {
      var cell_min1 = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 13];
      var cell_min2 = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 25];
      var cell_min3 = result.forecast[parseInt(options.pos) + forecastcurrentbucket - 37];
    }
    if (!cell_min3)
      cellstring += "<br><br>";
    else {
      cellstring += cell_min3.orderstotal + "<br>";
      {% if perms.forecast.change_forecastdemand %}
      cellstring += '<input type="number" min="0" tabindex="4" class="smallpadding adjhistory-3" value="' + ((cell_min3.ordersadjustment === null) ? '' : Math.round(cell_min3.ordersadjustment)) + '" oninput="onChange(event)" onclick="$(this).select();"/><br>';
      {% else %}
      cellstring += ((cell_min3.ordersadjustment === null) ? '' : Math.round(cell_min3.ordersadjustment)) + '<br>';
      {% endif %}
    }
    if (!cell_min2)
      cellstring += "<br/><br/>";
    else {
      cellstring += cell_min2.orderstotal + "<br/>";
      {% if perms.forecast.change_forecastdemand %}
      cellstring += '<input type="number" min="0" tabindex="3" class="smallpadding adjhistory-2" value="' + ((cell_min2.ordersadjustment === null) ? '' : Math.round(cell_min2.ordersadjustment)) + '" oninput="onChange(event)" onclick="$(this).select();"/><br>';
      {% else %}
      cellstring += ((cell_min2.ordersadjustment === null) ? '' : Math.round(cell_min2.ordersadjustment)) + '<br>';
      {% endif %}
    }
    if (!cell_min1)
      cellstring += "<br/><br/>";
    else {
      cellstring += cell_min1.orderstotal + "<br/>";
      {% if perms.forecast.change_forecastdemand %}
      cellstring += '<input type="number" min="0" tabindex="2" class="smallpadding adjhistory-1" value="' + ((cell_min1.ordersadjustment === null) ? '' : Math.round(cell_min1.ordersadjustment)) + '" oninput="onChange(event)" onclick="$(this).select();"/><br>';
      {% else %}
      cellstring += ((cell_min1.ordersadjustment === null) ? '' : Math.round(cell_min1.ordersadjustment)) + '<br>';
      {% endif %}
    }
  }
  cellstring += cell.orderstotal + "<br>";
  cellstring += cell.ordersopen + "<br>";
  cellstring += '<span class="bold">' + cell.forecastbaseline + "</span><br>";
  {% if perms.forecast.change_forecastdemand %}
  cellstring += '<input type="number" min="0" tabindex="1" class="smallpadding adjforecast" value="' + ((cell.forecastadjustment === null) ? '' : Math.round(cell.forecastadjustment)) + '" oninput="onChange(event)" onclick="$(this).select();"/><br>';
  {% else %}
  cellstring += Math.round(cell.forecastadjustment) + '<br>';
  {% endif %}
  return cellstring;
}


function plancell(cellvalue, options, rowObject)
{
  var cell = result.plan[parseInt(options.pos) - 1];
  if (!cell) return "s";
  var cellstring = "";
  cellstring += cell.roq + "<br>"{% if perms.input.change_purchaseorder %}
  cellstring += '<input type="number" min="0" tabindex="1" class="smallpadding roqoverride" value="' + ((cell.roqoverride === null) ? '' : Math.round(cell.roqoverride)) + '" oninput="onChange(event)" onclick="$(this).select();"/><br>';
  {% else %}
  cellstring += Math.round(cell.roqoverride) + '<br>';{% endif %}
  cellstring += cell.ss + "<br>"{% if perms.input.change_purchaseorder %}
  cellstring += '<input type="number" min="0" tabindex="2" class="smallpadding ssoverride" value="' + ((cell.ssoverride === null) ? '' : Math.round(cell.ssoverride)) + '" oninput="onChange(event);;" onclick="$(this).select();"/><br>';
  {% else %}
  cellstring += Math.round(cell.ssoverride) + '<br>';{% endif %}
  cellstring += cell.startoh + "<br>";
  cellstring += cell.dmdlocal + "<br>";
  cellstring += cell.dmddependent + "<br>";
  cellstring += '<span class="bold">' + cell.dmdtotal + "</span><br>";
  cellstring += cell.supplyconfirmed + "<br>";
  cellstring += cell.supplyproposed + "<br>";
  cellstring += '<span class="bold">' + cell.supply + "</span><br>";
  cellstring += cell.endoh + "<br>";
  return cellstring;
}


function displayPlanGraph()
{
	if (! "plan" in result)
		return;
  var margin = {top: 0, right: 130, bottom: 30, left: 50};
  var width = $("#content-main").width() - margin.left - margin.right;
  var height = $("#plangraph").height() - margin.top - margin.bottom;

  // Define X-axis
  var domain_x = [];
  var bucketnamelength = 0;
  for (var i in result.plan)
  {
    domain_x.push(result.plan[i].bucket);
    bucketnamelength = Math.max(result.plan[i].bucket.length, bucketnamelength);
  }
  var x = d3.scale.ordinal()
    .domain(domain_x)
    .rangeRoundBands([0, width], .1);
  var x_width = x.rangeBand();

  // Define Y-axis
  var y = d3.scale.linear().rangeRound([height, 0]);

  // Create a new SVG element
  $($("#plangraph").get(0)).html("");
  var svg = d3.select($("#plangraph").get(0))
    .append("svg")
    .attr("class","graphcell")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Get the maxima of the values
  var max_y = 0;
  var min_y = 0;
  for (var i in result.plan)
  {
    var tmp = result.plan[i];
    if (tmp.startoh > max_y)
       max_y = tmp.startoh;
    if (tmp.dmdtotal > max_y)
       max_y = tmp.dmdtotal;
    if (tmp.supply > max_y)
       max_y = tmp.supply;
    if (typeof tmp.roqoverride !== 'undefined')
    {
      if (tmp.roqoverride > max_y)
        max_y = tmp.roqoverride;
    }
    else if (tmp.roq > max_y)
      max_y = tmp.roq;
    if (typeof tmp.ssoverride !== 'undefined')
    {
      if (tmp.ssoverride > max_y)
        max_y = tmp.ssoverride;
    }
    else if (tmp.ss > max_y)
      max_y = tmp.ss;
    if (tmp.startoh < min_y)
       min_y = tmp.startoh;
  }

  // Update the scale of the Y-axis by looking for the max value
  y.domain([min_y, max_y]);
  var y_zero = y(0);

  // Create D3 bars
  var my_y;
  svg.selectAll("g")
    .data(result.plan)
    .enter()
    .append("g")
    .attr("transform", function(d) { return "translate(" + x(d.bucket) + ",0)"; })
    .on("click", function(d) {
        if (d3.event.defaultPrevented || (d.supply == 0 && d.dmdtotal == 0))
          return;
        d3.select("#tooltip").style('display', 'none');
        d3.event.stopPropagation();
      })
    .on("mouseenter", function(d) {
       graph.showTooltip(
         '<div style="text-align:center; font-weight:bold">'
         + d.bucket + '</div>'
         + '<table><tr><td>{{_('reorder quantity')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.roq*10)/10)
         + '</td></tr><tr><td>{{_('reorder quantity override')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.roqoverride*10)/10)
         + '</td></tr><tr><td>{{_('safety stock')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.ss*10)/10)
         + '</td></tr><tr><td>{{_('safety stock override')|capfirst}}</td><td style="text-align:right">'
         + ((d.ssoverride === null) ? '' : (Math.round(d.ssoverride*10)/10))
         + '</td></tr><tr><td>{{_('start inventory')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.startoh*10)/10)
         + '</td></tr><tr><td>{{_('end inventory')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.endoh*10)/10)
         + '</td></tr></table>'
         );
      })
    .on("mouseleave", graph.hideTooltip)
    .on("mousemove", graph.moveTooltip)
    .each(function(d) {
      var bucket = d3.select(this);
      var top;
      if (d['dmdtotal'] > 0)
      {
        my_y = y(d['dmdtotal']);
        bucket.append("rect")
          .attr("width", x_width/2)
          .attr("height", y_zero - my_y)
          .attr("y", my_y)
          .style("fill","#F6BD0F");
      }
      if (d['supply'] > 0)
      {
        my_y = y(d['supply']);
        bucket.append("rect")
          .attr("width", x_width/2)
          .attr("height", y_zero - my_y)
          .attr("x", x_width/2)
          .attr("y", my_y)
          .style("fill","#2B95EC");
      }
    });

  // Create D3 lines
  var line = d3.svg.line()
    .x(function(d) { return x(d.bucket) + x_width / 2; })
    .y(function(d) { return y(d.startoh); });
  svg.append("svg:path")
    .attr('class', 'graphline')
    .attr("stroke","#8BBA00")
    .attr("d", line(result.plan));
  var line = d3.svg.line()
    .x(function(d) { return x(d.bucket) + x_width / 2; })
    .y(function(d) {
         if (d.roqoverride !== null)
           return y(d.roqoverride);
         else
           return y(d.roq);
         });
  svg.append("svg:path")
    .attr('class', 'graphline')
    .attr("stroke","#f47a00")
    .attr("d", line(result.plan));
  var line = d3.svg.line()
    .x(function(d) { return x(d.bucket) + x_width / 2; })
    .y(function(d) {
         if (d.ssoverride !== null)
           return y(d.ssoverride);
         else
           return y(d.ss);
         });
  svg.append("svg:path")
    .attr('class', 'graphline')
    .attr("stroke","#FF0000")
    .attr("d", line(result.plan));

  // Display Y-Axis

  var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(d3.format("s"));
  svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

  // Display X-axis
  var nth = Math.ceil(result.plan.length / width * bucketnamelength * 10);
  var myticks = [];
  for (var i in result.plan)
    if (i % nth == 0) myticks.push(result.plan[i].bucket);
  var xAxis = d3.svg.axis()
    .scale(x)
    .tickValues(myticks)
    .orient("bottom");
  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

  // Display legend
  var legend = svg.append("g");
  var codes = [
    ["{{_('start inventory')|capfirst}}", "#8BBA00"],
    ["{{_('produced')|capfirst}}", "#2B95EC"],
    ["{{_('consumed')|capfirst}}", "#F6BD0F"],
    ["{{_('reorder quantity')|capfirst}}", "#f47a00"],
    ["{{_('safety stock')|capfirst}}", "#FF0000"]
    ];
  var visible = 0;
  for (var i in codes)
  {
    legend.append("rect")
      .attr("x", width + 82)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", codes[i][1])
      .attr("transform", "translate(0," + (visible*20+10) + ")");
    legend.append("text")
      .attr("x", width + 76)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(codes[i][0])
      .attr("transform", "translate(0," + (visible*20+10) + ")");
    visible += 1;
  }
}


function displayForecastGraph()
{
  var margin = {top: 0, right: 130, bottom: 30, left: 50};
  var width = $("#content-main").width() - margin.left - margin.right;
  var height = $("#forecastgraph").height() - margin.top - margin.bottom;

  // Define X-axis
  var domain_x = [];
  var bucketnamelength = 0;
  for (var i in result.forecast)
  {
    domain_x.push(result.forecast[i].bucket);
    bucketnamelength = Math.max(result.forecast[i].bucket.length, bucketnamelength);
    if (result.forecast[i].bucket == timebuckets[0].name)
    	forecastcurrentbucket = parseInt(i);
  }
  var x = d3.scale.ordinal()
    .domain(domain_x)
    .rangeRoundBands([0, width], .1);
  var x_width = x.rangeBand();

  // Define Y-axis
  var y = d3.scale.linear().rangeRound([height, 0]);

  // Create a new SVG element
  $($("#forecastgraph").get(0)).html("");
  var svg = d3.select($("#forecastgraph").get(0))
    .append("svg")
    .attr("class","graphcell")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Get the maxima of the values
  var max_y = 0;
  var min_y = 0;
  for (var i in result.forecast)
  {
    var tmp = result.forecast[i];
    if (tmp.orderstotal + tmp.ordersadjustment > max_y)
       max_y = tmp.orderstotal + tmp.ordersadjustment;
    if (tmp.forecasttotal > max_y)
       max_y = tmp.forecasttotal;
    if (tmp.orderstotal < min_y)
       min_y = tmp.orderstotal;
    if (tmp.forecasttotal < min_y)
       min_y = tmp.forecasttotal;
  }

  // Update the scale of the Y-axis by looking for the max value
  y.domain([min_y, max_y]);
  var y_zero = y(0);

  // Create D3 bars
  var my_y;
  svg.selectAll("g")
    .data(result.forecast)
    .enter()
    .append("g")
    .attr("transform", function(d) { return "translate(" + x(d.bucket) + ",0)"; })
    .on("click", function(d) {
        if (d3.event.defaultPrevented)
          return;
        d3.select("#tooltip").style('display', 'none');
        d3.event.stopPropagation();
      })
    .on("mouseenter", function(d) {
       graph.showTooltip(
         '<div style="text-align:center; font-weight:bold">'
         + d.bucket + '</div>'
         + '<table><tr><td>{{_('total orders')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.orderstotal*10)/10)
         + '</td></tr><tr><td>{{_('open orders')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.ordersopen*10)/10)
         + '</td></tr><tr><td>{{_('orders adjustment')|capfirst}}</td><td style="text-align:right">'
         + ((d.ordersadjustment === null) ? '' : (Math.round(d.ordersadjustment*10)/10))
         + '</td></tr><tr><td>{{_('forecast baseline')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.forecastbaseline*10)/10)
         + '</td></tr><tr><td>{{_('forecast override')|capfirst}}</td><td style="text-align:right">'
         + ((d.forecastadjustment === null) ? '' : Math.round(d.forecastadjustment*10)/10)
         + '</td></tr><tr><td>{{_('forecast total')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.forecasttotal*10)/10)
         + '</td></tr><tr><td>{{_('forecast net')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.forecastnet*10)/10)
         + '</td></tr><tr><td>{{_('forecast consumed')|capfirst}}</td><td style="text-align:right">'
         + (Math.round(d.forecastconsumed*10)/10)
         + '</td></tr></table>'
         );
      })
    .on("mouseleave", graph.hideTooltip)
    .on("mousemove", graph.moveTooltip)
    .each(function(d) {
      var bucket = d3.select(this);
      var top;
      if (d.ordersopen > 0)
      {
        my_y = y(d.ordersopen);
        bucket.append("rect")
          .attr("width", x_width)
          .attr("height", y_zero - my_y)
          .attr("x", x_width/2)
          .attr("y", my_y)
          .style("fill","#2B95EC");
      }
    });

  // Create D3 lines
  var line = d3.svg.line()
    .x(function(d) { return x(d.bucket) + x_width / 2; })
    .y(function(d) { return y(Math.max(0,d.orderstotal + d.ordersadjustment)); });
  svg.append("svg:path")
    .attr('class', 'graphline')
    .attr("stroke","#8BBA00")
    .attr("d", line(result.forecast));
  var line = d3.svg.line()
    .x(function(d) { return x(d.bucket) + x_width / 2; })
    .y(function(d) { return y(d['forecasttotal']); });
  svg.append("svg:path")
    .attr('class', 'graphline')
    .attr("stroke","#FF0000")
    .attr("d", line(result.forecast));

  // Display Y-Axis
  var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(d3.format("s"));
  svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

  // Display X-axis for a single forecast
  var nth = Math.ceil(result.forecast.length / width * bucketnamelength * 10);
  var myticks = [];
  for (var i in result.forecast)
    if (i % nth == 0) myticks.push(result.forecast[i].bucket);
  var xAxis = d3.svg.axis()
    .scale(x)
    .tickValues(myticks)
    .orient("bottom");
  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

  // Display legend
  var legend = svg.append("g");
  var codes = [
    ["{{_('open orders')|capfirst}}", "#2B95EC", 1],
    ["{{_('total orders')|capfirst}}", "#8BBA00", 0],
    ["{{_('forecast total')|capfirst}}", "#FF0000", 5]
    ];
  var visible = 0;
  for (var i in codes)
  {
    legend.append("rect")
      .attr("x", width + 82)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", codes[i][1])
      .attr("transform", "translate(0," + (visible*20+10) + ")");
    legend.append("text")
      .attr("x", width + 76)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(codes[i][0])
      .attr("transform", "translate(0," + (visible*20+10) + ")");
    visible += 1;
  }
}


function displayResult(reset)
{
  // Enable input elements
  $("#save, #undo, #commentitem, #commentitemlocation, #commentlocation").prop('disabled', false);

  // Debugging
  //console.log(result);

  // Update title
  if (result.type == "itemlocation")
    $("#detailtitle").html("{{_('buffer')|capfirst|force_escape}} " + result.name);
  else if (result.type == "item")
    $("#detailtitle").html("{{_('item')|capfirst|force_escape}} " + result.name);
  else if (result.type == "itemlocation")
    $("#detailtitle").html("{{_('location')|capfirst|force_escape}} " + result.name);

  // Update the forecasting parameters
  {% if perms.forecast.change_forecast %}
  if (reset)
	  $("#forecastmethod").removeClass('red');
  {% endif %}
  if ("forecastmethod" in result.parameters)
	  $("#forecastmethod").val(result.parameters.forecastmethod);
  if ("forecast_out_smape" in result.parameters)
    $("#forecast_out_smape").html(result.parameters.forecast_out_smape);
  if ("forecast_out_method" in result.parameters)
    $("#forecast_out_method").html(result.parameters.forecast_out_method);

  // Update the inventory planning parameters
  if ("roq_type" in result.parameters)
	  $("#roq_type_" + result.parameters.roq_type).prop("checked", true);
  if ("ss_type" in result.parameters)
	  $("#ss_type_" + result.parameters.ss_type).prop("checked", true);
  if ("roq_calculated" in result.parameters)
	  $("#roq_calculated").html(result.parameters.roq_calculated);
  if ("ss_calculated" in result.parameters)
	  $("#ss_calculated").html(result.parameters.ss_calculated);
  if ("nostock" in result.parameters)
	  $("#nostock").prop('checked', result.parameters.nostock);
  if ("roq_min_qty" in result.parameters)
    $("#roq_min_qty").val(result.parameters.roq_min_qty);
  if ("roq_min_poc" in result.parameters)
	  $("#roq_min_poc").val(result.parameters.roq_min_poc);
  if ("service_level" in result.parameters)
	  $("#service_level").val(result.parameters.service_level);
  if ("demand_deviation" in result.parameters)
	  $("#demand_deviation").val(result.parameters.demand_deviation);
  if ("leadtime_deviation" in result.parameters)
	  $("#leadtime_deviation").val(result.parameters.leadtime_deviation);
  if ("ss_min_qty" in result.parameters)
	  $("#ss_min_qty").val(result.parameters.ss_min_qty);
  if ("ss_min_poc" in result.parameters)
	  $("#ss_min_poc").val(result.parameters.ss_min_poc);
  if (reset)
  {
    $("label[for=nostock]").removeClass("red");
    $("label[for=roq_type_periodofcover], label[for=roq_type_calculated], label[for=roq_type_quantity]").removeClass("red");
    $("label[for=ss_type_periodofcover], label[for=ss_type_calculated], label[for=ss_type_quantity]").removeClass("red");
    $("#roq_min_qty").removeClass('dirty-cell');
    $("#roq_min_poc").removeClass('dirty-cell');
    $("#service_level").removeClass('dirty-cell');
    $("#demand_deviation").removeClass('dirty-cell');
    $("#leadtime_deviation").removeClass('dirty-cell');
    $("#ss_min_qty").removeClass('dirty-cell');
    $("#ss_min_poc").removeClass('dirty-cell');
  }

  // Show forecast tab
  displayForecastGraph(); // this function also sets the variable firstforecastbucket
  if (!$.trim($("#forecastgrid").html()))
  {
    // Forecast grid displayed for the first time
    $("#forecastgrid").jqGrid({
      data: [1],  // Dummy: single row
      datatype: 'local',
      jsonReader: { repeatitems: false },
      hoverrows: false,
      colModel:[
         {name:'fields',index:'fields',width:180,editable:false,label:' ',align:'left',title:false,key:true,counter:0,frozen:true,sortable:false,formatter:forecastfields},
         {% for f in request.report_bucketlist %}{% if not forloop.first %},
         {% endif %}{ name:'{{f.name|safe}}',startdate:'{{f.startdate|date:"Y-m-d"}}',enddate:'{{f.enddate|date:"Y-m-d"}}',sortable:false,width:90,align:'center',formatter:forecastcell,search:false,title:false }{% endfor %}
         ],
      iconSet: "fontAwesome",
      width: $('#content-main').width(),
      shrinkToFit: false,
      loadonce: true,
      beforeSelectRow: function() {return false},
      height: 'auto'
      });
    jQuery("#forecastgrid").jqGrid('setFrozenColumns');
    $("#forecastgrid").unbind("contextmenu");
  }
  else
  {
    // Refresh data in the forecast grid
    $('#forecastgrid')
      .jqGrid('clearGridData')
      .jqGrid('setGridParam', {data: [1]}) // Dummy: single row
      .trigger('reloadGrid');
  }

  // Show plan tab
  displayPlanGraph();
  if (!$.trim($("#plangrid").html()))
  {
    displayPlanGraph();
    // Plan grid displayed for the first time
    $("#plangrid").jqGrid({
      data: [1],
      datatype: 'local',
      jsonReader: { repeatitems: false },
      hoverrows: false,
      colModel:[
         {name:'fields',index:'fields',editable:false,label:' ',align:'left',title:false,key:true,counter:0,frozen:true,sortable:false,formatter:planfields},
         {% for f in request.report_bucketlist %}{% if not forloop.first %},
         {% endif %}{ name:'{{f.name|safe}}',startdate:'{{f.startdate|date:"Y-m-d"}}',enddate:'{{f.enddate|date:"Y-m-d"}}',sortable:false,width:90,align:'center',formatter:plancell,search:false,title:false }{% endfor %}
         ],
      iconSet: "fontAwesome",
      width: $('#content-main').width(),
      shrinkToFit: false,
      loadonce: true,
      beforeSelectRow: function() {return false;},
      height: 'auto'
      });
    jQuery("#plangrid").jqGrid('setFrozenColumns');
    $("#plangrid").unbind("contextmenu");
  }
  else if ("plan" in result)
  {
    // Refresh data in the plan grid
    $('#plangrid')
      .jqGrid('clearGridData')
      .jqGrid('setGridParam', {data: [1]})
      .trigger('reloadGrid');
  }

  // Show transaction tab
  var transactiondata = $.extend(true, [], result.transactions);
  if (!$.trim($("#transactiongrid").html()))
  {
    // Transaction grid displayed for the first time
    $("#transactiongrid").jqGrid({
      data: transactiondata,
      datatype: 'clientSide',
      jsonReader: { repeatitems: false },
      altRows: true,
      altclass: 'altRow',
      colModel:[
         {name:'id',index:'id',editable:false,label:'{% trans "identifier"|capfirst %}',align:'center',title:false,key:true,hidden:true,counter:0,frozen:true,searchoptions:{searchhidden: true}},
         {name:'date',index:'date',editable:false,label:'{% trans "date"|capfirst %}',align:'center',title:false,formatter:'date',formatoptions:{srcformat:'Y-m-d H:i:s',newformat:'Y-m-d H:i:s'},width:140,counter:1,searchoptions:{searchhidden: true}},
         {name:'type',index:'status',editable:false,label:'{% trans "type"|capfirst %}',align:'center',title:false,formatter:'select', edittype:'select', editoptions:{value:'DO out:DO out;DO in:DO in;PO:PO'},width:100,counter:2,searchoptions:{searchhidden: true}},
         {name:'reference',index:'reference',editable:true,label:'{% trans "reference"|capfirst %}',align:'left',title:false,width:200,counter:3,searchoptions:{searchhidden: true}{% if openbravo %}, editable: false{% endif %}},
         {name:'status',index:'status',editable:true,label:'{% trans "status"|capfirst %}',align:'center',title:false,formatter:'select', edittype:'select', editoptions:{value:'proposed:proposed;{% if openbravo %}approved:approved;{% endif %}confirmed:confirmed;closed:closed'}, {% if openbravo %}editable: false, {% endif %}width:100,counter:4,searchoptions:{searchhidden: true}},
         {name:'item',index:'item',editable:true,label:'{% trans "item"|capfirst %}',align:'left',title:false,formatter:'item',width:200,counter:5,searchoptions:{searchhidden: true}},
         {name:'location',index:'location',editable:true,label:'{% trans "location"|capfirst %}',align:'left',title:false,width:200,counter:6,searchoptions:{searchhidden: true}},
         {name:'origin',index:'origin',editable:true,label:'{% trans "origin"|capfirst %}',align:'left',title:false,width:200,counter:7,searchoptions:{searchhidden: true}},
         {name:'startdate',index:'startdate',editable:true,label:'{% trans "start date"|capfirst %}',align:'center',title:false,formatter:'date',formatoptions:{srcformat:'Y-m-d H:i:s',newformat:'Y-m-d H:i:s'},width:140,counter:8,searchoptions:{searchhidden: true}},
         {name:'enddate',index:'enddate',editable:true,label:'{% trans "end date"|capfirst %}',align:'center',title:false,formatter:'date',formatoptions:{srcformat:'Y-m-d H:i:s',newformat:'Y-m-d H:i:s'},width:140,counter:9,searchoptions:{searchhidden: true}},
         {name:'quantity',index:'quantity',editable:true,label:'{% trans "quantity"|capfirst %}',align:'center',title:false,formatter:'number',searchrules:{number:true},width:70,counter:10,searchoptions:{searchhidden: true}},
         {name:'value',index:'value',editable:true,label:'{% trans "value"|capfirst %}',align:'center',title:false,formatter:'number',searchrules:{number:true},width:70,counter:11,searchoptions:{searchhidden: true}},
         {name:'criticality',index:'criticality',editable:false,label:'{% trans "criticality"|capfirst %}',align:'center',title:false,formatter:'number',searchrules:{number:true},width:70,counter:12,searchoptions:{searchhidden: true}},
         {name:'lastmodified',index:'lastmodified',editable:false,label:'Last Modified',align:'center',title:false,formatter:'date',formatoptions:{srcformat:'Y-m-d H:i:s',newformat:'Y-m-d H:i:s'},width:140,counter:13,searchoptions:{searchhidden: true}}
         ],
      rowNum:20,
      rowList:[20, 30, 50],
      iconSet: "fontAwesome",
      sortname: 'date',
      sortorder: "asc",
      width: $('#content-main').width(),
      height: 'auto',
      {% if perms.input.change_purchaseorder or perms.input.change_distributionorder %}
      multiselect: true,
      cellEdit: true,
      {% endif %}
      cellsubmit: 'clientArray',
      editurl: location.pathname,
      afterEditCell: grid.afterEditCell,
      beforeSaveCell: select,
      onSelectRow: markSelectedRow
        });
    $("#transactiongrid").jqGrid('setFrozenColumns');
    $('#cb_transactiongrid.cbox').click(grid.markAllRows);
  }
  else if ("transactions" in result)
  {
    // Refresh data in the transaction grid
    $('#transactiongrid')
      .jqGrid('clearGridData')
      .jqGrid('setGridParam', {data: result.transactions})
      .trigger('reloadGrid');
  }

  // Show comments
  // Note that a recalculate doesn't send back the comments, and we don't change the existing content
  if ("comments" in result)
	{
	  $("#commentlocation, #commentitem, #commentitemlocation").removeClass("comment_button_active ui-state-disabled");
	  $("#newcomment:visible").css("display", "none");
	  var comments = $("#pastcomments");
	  comments.empty();
	  for (var c in result.comments)
	  {
	    $("<hr/>").appendTo(comments);
	    $("<h3/>").text(result.comments[c].user + " " + result.comments[c].type).appendTo(comments);
	    $("<span class='float_right'></span>").text(result.comments[c].lastmodified).appendTo(comments);
	    $("<pre/>").text(result.comments[c].comment).appendTo(comments);
	  }
	}

  // Show history tab
  // Note that a recalculate doesn't send back the history, and we don't change the existing content
  if ("history" in result)
	{
	  var history = $("#history");
	  history.empty();
	  for (var c in result.history)
		{
	    var i = $("<div/>");
	    $("<span style='font-weight: bold'/>").text(result.history[c].content_type + ' ' + result.history[c].object_id + ': ').appendTo(i);
	    $("<span class='float_right'/>").text(result.history[c].user + " " + result.history[c].action_time).appendTo(i);
	    $("<span/>").text(result.history[c].change_message).appendTo(i);
	    i.appendTo(history);
		}
	}
}


function selectTab(value)
{
  // Nothing changed
  if (value === showtab) return;

  if (showtab != null)
  {
    // Hide previous tab
    $("#" + showtab + "tab").removeClass("frepple-tabs-active");
    $("#" + showtab + "data").css("display", "none");

    // Show new tab
    showtab = value;
    $("#" + showtab + "tab").addClass("frepple-tabs-active");
    $("#" + showtab + "data").css("display", "block");

    // Save newly selected table as a preference
    grid.saveColumnConfiguration();
  }
  else
  {
    // Show new tab
    showtab = value;
    $("#" + showtab + "tab").addClass("frepple-tabs-active");
    $("#" + showtab + "data").css("display", "block");
  }
  if (showtab == "transactions")
    $('#actions').css("display", "initial");
  else
    $('#actions').css("display", "none");
  return false;
}


function setCommentType(t)
{
  if (t == "item")
    $("#commentitemlocation, #commentlocation").removeClass("comment_button_active ui-state-disabled");
  else if (t == "location")
    $("#commentitemlocation, #commentitem").removeClass("comment_button_active ui-state-disabled");
  else
    $("#commentlocation, #commentitem").removeClass("comment_button_active ui-state-disabled");
  $("#comment" + t).addClass("comment_button_active ui-state-disabled");
  $("#newcomment:hidden").toggle();
}


$(function() {
  {% if preferences.name and not args %}selectRow("{{ preferences.name|escapejs }}");
  {% elif args.1 %}selectRow("{{ args.0|escapejs }}@{{ args.1|escapejs }}");{% endif %}
  selectTab("{% if preferences.showtab %}{{ preferences.showtab }}{% else %}plan{% endif %}");

  $("#units").buttonset();
  $("#unitsmode").click(function() {changeUnits("value");});
  $("#valuemode").click(function() {changeUnits("units");});

  // Resize the grids when the window size changes
  $(window).bind('resize', function() {
	  var newsize = $('#content-main').width();
	  $("#plangrid").setGridWidth(newsize);
	  $("#transactiongrid").setGridWidth(newsize);
	  $("#forecastgrid").setGridWidth(newsize);
	});
});

</script>
{% endblock %}

{% block save_undo_buttons %}<div style="float:left"><select id="grouping" onchange="changeGrouping()">
  <option value="itemlocation"{% if not "grouping" in preferences or preferences.grouping == 'itemlocation' %} selected{% endif %}>{% filter capfirst %}{% trans "no grouping"|capfirst %}{% endfilter %}</option>
  <option value="item"{% if preferences.grouping == 'item' %} selected{% endif %}>{% filter capfirst %}{% trans "group by item"|capfirst %}{% endfilter %}</option>
  <option value="location"{% if preferences.grouping == 'location' %} selected{% endif %}>{% filter capfirst %}{% trans "group by location"|capfirst %}{% endfilter %}</option>
</select></div>{% endblock %}

{% block actions %}<form style="display: inline"><span id="units">
<input type="radio" id="unitsmode" name="units" value="value" {% if not "units" in preferences or preferences.units == 'value' %}checked{% endif %}><label for="unitsmode"><span title="{% trans "display value"|capfirst|force_escape %}" class="fa fa-dollar fa-lg" style="color:#4c3000"></span></label>
<input type="radio" id="valuemode" name="units" value="units" {% if "units" in preferences and preferences.units == 'units' %}checked{% endif %}><label for="valuemode"><span title="{% trans "display units"|capfirst|force_escape %}" class="fa fa-truck fa-lg" style="color:#4c3000"></span></label>
</span></form>&nbsp;&nbsp;
<span id="filter" onclick="grid.showFilter()" title="{% trans 'filter data'|capfirst|force_escape %}" class="fa fa-search fa-lg"></span>
<span onclick="grid.showBucket()" title="{% trans 'Configure time buckets'|escape %}" id="bucketconfig" class="fa fa-clock-o fa-lg"></span>
<span onclick="grid.showExport(true)" title="{% trans 'Export as CSV or Excel file'|escape %}" class="fa fa-arrow-down fa-lg"></span>
<span onclick="grid.showCustomize(false);" title="{% trans 'customize'|capfirst|force_escape %}" class="fa fa-wrench fa-lg"></span>{% endblock %}
{% block after_table %}
<br/>
<div id="detail"><h1 id="detailtitle">{% trans "detail"|capfirst %}</h1>
{% if perms.input.change_purchaseorder or perms.input.change_distributionorder or perms.forecast.change_forecastdemand or perms.input.change_calendarbucket or perms.forecast.change_forecast or perms.inventoryplanning.change_inventoryplanning %}
{% comment %}Translators: Translation included with Django {% endcomment %}
&nbsp;&nbsp;<input type="submit" value="{% filter upper|force_escape %}{% trans 'Save' %}{% endfilter %}" id="save" class="button ui-corner-all save_undo_button_inactive" role="button" onclick="save(false)" title="{% trans 'save changes'|capfirst|force_escape %}">
&nbsp;&nbsp;<input type="submit" value="{% filter upper|force_escape %}{% trans 'Undo' %}{% endfilter %}" id="undo" class="button ui-corner-all save_undo_button_inactive" role="button" onclick="undo()" title="{% trans 'undo changes'|capfirst|force_escape %}">
&nbsp;&nbsp;<input type="submit" value="{% filter upper|force_escape %}{% trans 'Recalculate' %}{% endfilter %}" id="recalculate" class="button ui-corner-all save_undo_button_inactive" role="button" onclick="save(true)" title="{% trans 'simulate changes without saving'|capfirst|force_escape %}">
{% endif %}
{% if perms.input.change_purchaseorder or perms.input.change_distributionorder %}
&nbsp;&nbsp;<select disabled='disabled' name="actions" id="actions" onchange="javascript: if ( $(this).val() == 'openbravo_export') {openbravo.IncrementalExport(jQuery('#transactiongrid'),'all');} else {setStatus($(this).val());}" style="display: initial" class="ui-corner-all ui-selectmenu-disabled ui-state-disabled change_status_selectmenu_inactive" >
  <option value='no_action'>{% trans "select action"|capfirst %}</option>
  {% if openbravo %}
  <option value='openbravo_export'>{% filter capfirst %}{% trans "incremental export to openbravo" %}{% endfilter %}</option>
  {% else %}
  <option value='proposed'>{% filter capfirst %}{% blocktrans with status=_("proposed") %}change status to {{status}}{% endblocktrans %}{% endfilter %}</option>
  <option value='confirmed'>{% filter capfirst %}{% blocktrans with status=_("confirmed") %}change status to {{status}}{% endblocktrans %}{% endfilter %}</option>
  <option value='closed'>{% filter capfirst %}{% blocktrans with status=_("closed") %}change status to {{status}}{% endblocktrans %}{% endfilter %}</option>
  {% endif %}
</select>
{% endif %}
<div class="frepple-tabs" id="tabs">
<ul role="tablist">
<li id="forecasttab" role="tab"><a class="ui-tabs-anchor" onclick="return selectTab('forecast')">{% trans 'forecast'|capfirst %}</a></li>
<li id="plantab" role="tab"><a class="ui-tabs-anchor" onclick="return selectTab('plan')">{% trans 'plan'|capfirst %}</a></li>
<li id="transactionstab" role="tab"><a class="ui-tabs-anchor" onclick="return selectTab('transactions')">{% trans 'transactions'|capfirst %}</a></li>
<li id="commentstab" role="tab"><a class="ui-tabs-anchor" onclick="return selectTab('comments')">{% trans 'comments'|capfirst %}</a></li>
{% comment %}Translators: Translation included with Django {% endcomment %}
<li id="historytab" role="tab"><a class="ui-tabs-anchor" onclick="return selectTab('history')">{% trans 'History'|capfirst %}</a></li>
</ul>
</div>

<div id="forecastdata" class="clear" style="display:none">
<div id="forecastgraph" style="clear: both; height: 200px; padding: 10px; "></div>
<table id="forecastgrid"></table><br/>
<h2>{% trans "parameters"|capfirst %}</h2>
<table><tr><td>{% trans "forecast method"|capfirst %}</td><td>&nbsp;&nbsp;{% if perms.forecast.change_forecast %}<select id="forecastmethod" onchange="setForecastMethod($(this).val())">
<option value="Automatic">{% trans "automatic" context "forecast method"%}</option>
<option value="Constant">{% trans "constant" context "forecast method" %}</option>
<option value="Trend">{% trans "trend" context "forecast method" %}</option>
<option value="Seasonal">{% trans "seasonal" context "forecast method" %}</option>
<option value="Intermittent">{% trans "intermittent" context "forecast method" %}</option>
<option value="Moving average">{% trans "moving average" context "forecast method" %}</option>
<option value="Manual" selected="selected">{% trans "manual" context "forecast method" %}</option>
</select>{% else %}<span id="forecastmethod"></span>{% endif %}</td></tr>
<tr><td>{% trans "selected forecast method"|capfirst %}</td><td>&nbsp;&nbsp;<span id="forecast_out_method"></span></td></tr>
<tr><td>{% trans "estimated forecast error"|capfirst %}</td><td>&nbsp;&nbsp;<span id="forecast_out_smape"></span>&nbsp;%</td></tr></table>
</div>

<div id="plandata" class="clear" style="display:none">
<div id="plangraph" style="clear: both; height: 200px; padding: 10px; "></div>
<table id="plangrid"></table><br/>
<h2>{% trans "parameters"|capfirst %}</h2>
<table><tr><td class="bold">{% trans "reorder quantity"|capfirst %}</td>
<td class="bold">{% trans "safety stock"|capfirst %}</td></tr>
<tr><td valign="top">
<input type="radio" id="roq_type_calculated" name="roq_type" value="calculated" {% if perms.inventoryplanning.change_inventoryplanning %}onclick="clickROQtype()"{% else %}disabled="disabled"{% endif %}><label for="roq_type_calculated">&nbsp;{% trans "economic order quantity"|capfirst %}: <span id="roq_calculated">&nbsp;&nbsp;&nbsp;&nbsp;</span> {% trans "units"|capfirst %}&nbsp;&nbsp;&nbsp;&nbsp;</label><br/>
<input type="radio" id="roq_type_quantity" name="roq_type" value="quantity" {% if perms.inventoryplanning.change_inventoryplanning %}onclick="clickROQtype()"{% else %}disabled="disabled"{% endif %}><label for="roq_type_quantity">&nbsp;{% trans "quantity"|capfirst %}&nbsp;<input style="width:80px" type="number" id="roq_min_qty"{% if perms.change_inventoryplanning %} oninput="activateSaveUndo(); $(this).addClass('dirty-cell')" {% else %} readonly="true" {% endif %}min="1"> {% trans "units"|capfirst %}</label><br/>
<input type="radio" id="roq_type_periodofcover" name="roq_type" value="periodofcover" {% if perms.inventoryplanning.change_inventoryplanning %}onclick="clickROQtype()"{% else %}disabled="disabled"{% endif %}><label for="roq_type_periodofcover">&nbsp;{% trans "period of cover"|capfirst %}&nbsp;<input style="width:50px" type="number" id="roq_min_poc"{% if perms.inventoryplanning.change_inventoryplanning %} oninput="activateSaveUndo(); $(this).addClass('dirty-cell')" {% else %} readonly="true" {% endif %}min="1" step="1"> {% trans "days" %}</label><br/>
</td><td valign="top">
<input type="radio" id="ss_type_calculated" name="ss_type" value="calculated" {% if perms.inventoryplanning.change_inventoryplanning %}onclick="clickSStype()"{% else %}disabled="disabled"{% endif %}><label for="ss_type_calculated">&nbsp;{% trans "service level"|capfirst %}: <span id="ss_calculated">&nbsp;&nbsp;&nbsp;&nbsp;</span> {% trans "units" %}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% trans "minimum"|capfirst %} <input type="number" id="service_level"{% if perms.inventoryplanning.change_inventoryplanning %} oninput="activateSaveUndo(); $(this).addClass('dirty-cell')" {% else %} readonly="true" {% endif %}min="0" max="100" size="7"> %<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% trans "demand standard deviation"|capfirst %} <input style="width:80px" type="number" id="demand_deviation"{% if perms.inventoryplanning.change_inventoryplanning %} oninput="activateSaveUndo(); $(this).addClass('dirty-cell');" {% else %} readonly="true" {% endif %}size="7"> {% trans "units" %}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{% trans "lead time standard deviation"|capfirst %} <input style="width:80px" type="number" id="leadtime_deviation"{% if perms.inventoryplanning.change_inventoryplanning %} oninput="activateSaveUndo(); $(this).addClass('dirty-cell')" {% else %} readonly="true" {% endif %}size="7"> {% trans "days" %}</label><br/>
<input type="radio" id="ss_type_quantity" name="ss_type" value="quantity" {% if perms.inventoryplanning.change_inventoryplanning %}onclick="clickSStype()"{% else %}disabled="disabled"{% endif %}><label for="ss_type_quantity">&nbsp;{% trans "quantity"|capfirst %}<input style="width:80px" type="number" id="ss_min_qty"{% if perms.change_inventoryplanning %}  oninput="activateSaveUndo(); $(this).addClass('dirty-cell')" {% else %} readonly="true" {% endif %}min="1"> {% trans "units"|capfirst %}</label><br/>
<input type="radio" id="ss_type_periodofcover" name="ss_type" value="periodofcover" {% if perms.inventoryplanning.change_inventoryplanning %}onclick="clickSStype()"{% else %}disabled="disabled"{% endif %}><label for="ss_type_periodofcover">&nbsp;{% trans "period of cover"|capfirst %}<input style="width:50px" type="number" id="ss_min_poc" min="1" step="7"{% if perms.inventoryplanning.change_inventoryplanning %}  oninput="activateSaveUndo(); $(this).addClass('dirty-cell')"{% else %} readonly="true"{% endif %}> {% trans "days" %}</label><br/>
</td></tr>
</table>
<input type="checkbox" id="nostock" {% if perms.inventoryplanning.change_inventoryplanning %}onclick="clickNoStock()"{% else %}disabled="disabled"{% endif %}>&nbsp;&nbsp;<label for="nostock">{% trans "don't stock"|capfirst %}</label>
</div>

<div id="transactionsdata" class="clear" style="display:none">
<table id="transactiongrid"></table>
</div>
<div id="commentsdata" class="clear" style="display:none">
{% if perms.common.add_comment %}<input type="submit"  role="button" id="commentitem" value="{% trans 'new item comment'|capfirst %}" onclick="return setCommentType('item')" aria-disabled="false" style="font-size:12px" disabled="disabled" class="ui-button ui-widget ui-state-default ui-state-disabled ui-corner-all" />
&nbsp;&nbsp;
<input type="submit"  role="button" id="commentitemlocation" value="{% trans 'new item-location comment'|capfirst %}" onclick="return setCommentType('itemlocation')" aria-disabled="false" style="font-size:12px" disabled="disabled" class="ui-button ui-widget ui-state-default ui-state-disabled ui-corner-all" />
&nbsp;&nbsp;
<input type="submit"  role="button" id="commentlocation" value="{% trans 'new location comment'|capfirst %}" onclick="return setCommentType('location')" aria-disabled="false" style="font-size:12px" disabled="disabled" class="ui-button ui-widget ui-state-default ui-state-disabled ui-corner-all" />
&nbsp;&nbsp;
<textarea style="display:none; width:100%" id="newcomment" name="comment" rows="5" oninput="activateSaveUndo()"></textarea><br/>{% endif %}
<span id="pastcomments">{% trans "no comments yet"|capfirst %}</span>
</div>

<div id="historydata" class="clear" style="display:none"><span id="history"></span></div>
</div>
{% endblock %}
