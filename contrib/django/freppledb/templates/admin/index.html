{% extends "admin/base_site_nav.html" %}
{% load i18n %}

{% block title %}frePPLe{% endblock %}
{% block content_title %}<div id="toolicons"><span onclick="dashboard.customize();" title="{% trans 'customize'|capfirst|force_escape %}" class="fa fa-wrench fa-lg"></span></div>
<h1>{% trans "cockpit"|capfirst %}</h1>{% endblock %}
{% block extrahead %}{{block.super}}
<script type="text/javascript" src="/static/js/d3.min.js"></script>
<script type="text/javascript" src="/static/js/jquery-ui-1.11.4.min.js"></script>
<script>
  $(function() {
    $(".cockpitcolumn").sortable({
      connectWith: ".cockpitcolumn",
      handle: ".panel-heading",
      cancel: ".panel-toggle",
      placeholder: "panel-placeholder"
    });
    $(".panel-toggle").click(function() {
      var icon = $(this);
      icon.toggleClass("fa-minus fa-plus");
      icon.closest(".panel").find(".panel-body").toggle();
    });
    $(".panel-close").click(function() {
      $(this).closest(".panel").remove();
      dashboard.save();
    });
    $("#toolicons").tooltip({show: {effect: "fade", delay: 500}});
  });
</script>
{% endblock %}

{% block content %}
{% getDashboard as dashboard hiddenwidgets %}
{% for row in dashboard %}
    <div class="row"><div class="col-md-6 col-sm-12 ui-sortable"><h1 style="float: left">{{ row.rowname }}</h1></div></div>
    <div class="row" id="{{ row.rowname }}">
				{% for cols in row.cols %}
				<div class="cockpitcolumn {{cols.width}}">
					  {% for widget in cols.widgets %}<div class="panel panel-default">
					  <div class="panel-heading" data-toggle="tooltip" data-placement="top" title="{{widget.tooltip|escape}}">
						    <span class='fa fa-times pull-right panel-close'></span>
						    <span class='fa fa-minus pull-right panel-toggle'></span>
						    {% if widget.exporturl %}<a href="{{request.prefix}}{{widget.url}}&amp;format=spreadsheet"><span class='fa fa-arrow-down pull-right portlet-export'></span></a>{% endif %}
						    {% if widget.url %}<a href="{{request.prefix}}{{widget.url}}">{{widget.title|upper}}</a>{% else %}{{widget.title|upper}}{% endif %}
  </div>
					  <div class="panel-body">{% if widget.asynchronous %}<div id="widget_{{widget.name}}" style="text-align:center"><img src="{{STATIC_URL}}img/loading.gif" height="32" alt="loading"></div>{% else %}{{widget.render|safe}}{% endif %}</div>
					  </div>
					  {% endfor %}
				</div>
		    {% endfor %}
    </div>
{% endfor %}

{% for row in dashboard %}
		{% for col in row.cols %}{% if forloop.first %}<script>{% endif %}
				{% for widget in col.widgets %}
			     {% if widget.asynchronous %}$.ajax({
      url: "{{request.prefix}}/widget/{{widget.name}}/{{widget.args}}",
      type: "GET",
      success: function (data) {
        $("#widget_{{widget.name}}").parent().html(data);
        {{widget.javascript|safe}}
        },
      error: function (result, stat, errorThrown) {
        $("#widget_{{widget.name}}").parent().html("{% trans "failed"|capfirst %}");
        }
    });
				  {% else %}{{widget.javascript|safe}}
				  {% endif %}
				{% endfor %}
				{% if forloop.last %}</script>{% endif %}
		{% endfor %}
{% endfor %}
<script>
var hiddenwidgets = [
{% for key, value in hiddenwidgets.items%}{% if not forloop.first %},
{% endif %}  ["{{key|escapejs}}","{{value.title|escapejs}}"]{% endfor %}
];
</script>
{% endblock %}
