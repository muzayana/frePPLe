{% extends "admin/base_site_nav.html" %}
{% load i18n %}

{% block extrahead %}{{block.super}}
<script type="text/javascript">

var reportkey = '{{reportkey|safe}}';
var initialfilter{% if filters %} = {{filters|safe}}{% endif %};
var resizing;
var editrow;
var editcol;

{% if reportclass.hasTimeBuckets %}var numbuckets = {{request.report_bucketlist|length}};
{% endif %}

{% if actions %}var actions = {   {% for i in actions %}
   "{{ i.name|escape }}": function() { {{ i.function|safe }} }{% if not forloop.last %},{% endif %}{% endfor %}
   };{% endif %}

$(function() {
  {% if reportclass.hasTimeBuckets and not bucketnames %}
  $('#curfilter').html("{% trans 'Error: Missing time buckets or bucket dates' %}");
{% else %}
  jQuery("#grid").jqGrid({
   	url: (location.href.indexOf("#") != -1 ? location.href.substr(0,location.href.indexOf("#")) : location.href)
   	  + (location.search.length > 0 ? "&format=json" : "?format=json"),
	  datatype: "json",
	  jsonReader : {repeatitems:false},
    colModel:[{{colmodel|safe}}],
   	rowNum: {{request.pagesize}},{% if is_popup %}
    onSelectRow: grid.setSelectedRow,{% elif reportclass.editable and haschangeperm %}
    cellEdit: true,
    cellsubmit: 'clientArray',
    editurl: location.pathname,
    afterEditCell: grid.afterEditCell,
    beforeSaveCell: upload.select,{% else %}
    onSelectRow: function() {$(this).resetSelection();},{% endif %}
    pager: '#gridpager',
    iconSet: "fontAwesome",
    guiStyle: "bootstrapPrimary",
    viewrecords: true,
    sortorder: "{{sord}}",
    sortname: "{{sidx}}",
    page: {{page}},
    hidegrid: false,
    resizeStop: grid.saveColumnConfiguration,
    scrollRows: true,
    onSortCol: function (index, columnIndex, sortOrder) {
      $('#grid').setGridParam('sortname',columnIndex);
      $('#grid').setGridParam('sortorder',sortOrder);
      grid.saveColumnConfiguration();
    },
    onPaging: grid.saveColumnConfiguration,
    //scroll: 1,      // Enables scrolling over all records, instead of paging. But not compatible with frozen columns.
    //sortable: true, // Allows columns to be dragged and dropped between positions. But not compatible with frozen columns
    autowidth: true,{% if filters %}
    postData: {filters: JSON.stringify(initialfilter)},
    search : true,{% endif %}
    shrinkToFit: false,
    searching: {
      multipleSearch: true,
      multipleGroup: true,
      closeOnEscape: true,
      searchOnEnter: true,
      searchOperators: true,
      zIndex: 5000,
      width: 550,
      height: 300
    },

    loadError: function(xhr,st,err) {
      if (xhr.status == 200)
      {
        $('#curfilter').html("{{_('Warning: no data found')|escapejs}}");
        $('#grid').clearGridData();
      }
      else
        $('#curfilter').html("{{_('Error retrieving report data')|escapejs}}" + ":&nbsp;" + xhr.status + "&nbsp;" + xhr.statusText);
    },{% if reportclass.editable and reportclass.multiselect and not is_popup and hasaddperm %}
    multiselect: true,
    onSelectRow: grid.markSelectedRow,
    formatCell: function(rowid, cellname, value, iRow, iCol) {
      editrow = iRow;
      editcol = iCol;
      return value;
    }, {% endif %}
    {% block extra_grid %}{% endblock %}
    height: {% if reportclass.height %}{% if "height" in preferences %}{{preferences.height}}{% else %}{{reportclass.height}}{% endif %}{% else %}($(window).height() - $("#grid").offset().top - 63 < 150) ? 150 : $(window).height() - $("#grid").offset().top - 63{% endif %}
    });{% if reportclass.frozenColumns > 0 %}
  jQuery("#grid").jqGrid('setFrozenColumns');{% endif %}{% if reportclass.multiselect and not is_popup %}
  $('#cb_grid.cbox').click(grid.markAllRows);{% endif %}{% if reportclass.editable and haschangeperm %}
  $("th").bindFirst('click', upload.validateSort);{% endif %}
  {% if reportclass.height %}$("#grid").gridResize({
     handles: 's', minHeight: {{reportclass.height}},
     resize: function() {
       // Save the configuration if we don't get any more resizing events in 200ms.
       clearTimeout(resizing);
       resizing = setTimeout(grid.saveColumnConfiguration, 200);
       }
     });
  {% endif %}{% endif %}{% if filters %}
  var f = grid.getFilterGroup(initialfilter, true);
  if (f) $('#curfilter').html(gettext("Filtered where") + " " + f);{% endif %}
  $("#grid").on('input', function() {
	  $("#save").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled", false);
	  $("#undo").removeClass("btn-primary btn-danger").addClass("btn-danger").prop("disabled", false);
	  });

	$(window).bind('resize', function() {
  var h = $(window).height() - $("#grid").offset().top - 63;
  if (h < 150) h = 150;
  $("#grid")
   .setGridWidth($('#content-main').width()){% if not reportclass.height %}
   .setGridHeight(h){% endif %};
	});

	$("#horizonbucketsul li a").click(function(){
	  $("#horizonbuckets1").html($(this).text() + '  <span class="caret"></span>');
	  $("#horizonbuckets").val($(this).prop('name'));
	});

	$("#horizonunitul li a").click(function(){
	  $("#horizonunit1").html($(this).text() + '  <span class="caret"></span>');
	  $("#horizonunit").val($(this).prop('name'));
	});

  $("#actionsul li a").click(function(){
    $("#actions1").html($(this).text() + ' <span class="caret"></span>');
    $("#actions").val($(this).prop('name'));
    grid.runAction($(this).prop('name'));
  });

});
</script>
{% endblock %}
{% block content %}
{% block before_table %}{% endblock %}

<div class="row">

<div id="save_undo" class="col-xs-5 form-inline">

{% block save_undo_buttons %}
{% if not is_popup and reportclass.editable and haschangeperm %}
{% comment %}Translators: Translation included with Django {% endcomment %}

<input type="submit" value="{% filter force_escape|upper %}{% trans "Save" %}{% endfilter %}" class="btn btn-primary"  disabled role="button" id="save" onclick="upload.save()" title="{% trans 'save changes'|capfirst|force_escape %}">
<input type="submit" value="{% filter force_escape|upper %}{% trans "Undo" %}{% endfilter %}" class="btn btn-primary"  disabled role="button" id="undo" onclick="upload.undo()" title="{% trans 'undo changes'|capfirst|force_escape %}">
{% if actions %}
<form class="form-addon" method="get" action="#" style="display: inline;" >
  <input type="hidden" name="actions" id="actions" value="">
  <div class="dropdown dropdown-submit-input" style="display: inline;">
      <button disabled class="btn btn-default dropdown-toggle form-control" type="button" name="actions1" id="actions1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
      {% trans "select action"|capfirst %}&nbsp;&nbsp;<span class="caret"></span>
      </button>
      <ul class="dropdown-menu" name="actionsul" id="actionsul" aria-labelledby="actions1" style="top: auto;">
        <li><a name="no_action">{% trans "select action"|capfirst %}</a></li>
      {% for i in  actions %}
        <li><a onclick="" name="{{ i.name|escape }}">{% trans i.label|capfirst %}</a></li>
      {% endfor %}
      </ul>
  </div>
</form>
{% endif %}
{% endif %}
{% endblock save_undo_buttons %}
</div>

<div id="toolicons" class="col-xs-4 hor-align-right ver-align-middle pull-right">{% block actions %}
{% if reportclass.filterable %}
<button class="btn btn-xs btn-primary" id="filter" onclick="grid.showFilter()" data-toggle="tooltip" data-placement="top" data-original-title="{% trans 'filter data'|capfirst|force_escape %}" ><span class="fa fa-search"></span></button>{% endif %}
{% if hasaddperm %}<button class="btn btn-xs btn-primary" onclick="location.href='{{request.prefix}}/data/{{model|app_label}}/{{model|object_name|lower}}/add/{% if is_popup %}?_popup=1{% endif %}'" data-toggle="tooltip" data-placement="top" data-original-title="{% trans "Create new object"|escape %}" ><span class="fa fa-plus"></span></button>
{% if not is_popup %}<button class="btn btn-xs btn-primary"  disabled id="copy_selected" onclick="grid.showCopy()" data-toggle="tooltip" data-placement="top" data-original-title="{% trans 'Copy selected objects'|escape %}" ><span class="fa fa-copy"></span></button>
{% endif %}{% endif %}{% if hasdeleteperm and not is_popup %}<button class="btn btn-xs btn-primary" id="delete_selected" disabled data-toggle="tooltip" data-placement="top" data-original-title="{% trans 'Delete selected objects'|escape %}" onclick="grid.showDelete()" ><span class="fa fa-minus"></span></button>
{% endif %}{% if reportclass.hasTimeBuckets %}<button class="btn btn-xs btn-primary" onclick="grid.showBucket()" data-toggle="tooltip" data-placement="top" data-original-title="{% trans 'Configure time buckets'|escape %}" id="bucketconfig"><span class="fa fa-clock-o"></span></button>
{% endif %}{% if hasaddperm %}<button class="btn btn-xs btn-primary" id="csvimport" data-toggle="tooltip" data-placement="top" data-original-title="{% trans 'import CSV or Excel file'|capfirst|force_escape %}" onclick="import_show()"><span class="fa fa-arrow-up"></span></button>
{% endif %}<button class="btn btn-xs btn-primary" onclick="grid.showExport(true)" data-toggle="tooltip" data-placement="top" data-original-title="{% trans 'export as CSV or Excel file'|capfirst|force_escape %}"><span class="fa fa-arrow-down"></span></button>
<button class="btn btn-xs btn-primary" onclick="grid.showCustomize(false);" data-toggle="tooltip" data-placement="top" data-original-title="{% trans 'customize'|capfirst|force_escape %}"><span class="fa fa-wrench"></span></button>{% endblock %}
</div>

</div>

<div class="row">
<div id="content-main" class="col-md-12" style="min-height: 150px; margin-top: 0.7em">
<table id="grid" class="table table-striped" style="background-color: white"></table>
<div id="gridpager"></div>
</div>
</div>

{% block after_table %}{% endblock %}

{% if reportclass.hasTimeBuckets %}
<div  id="timebuckets" class="modal fade" role="dialog" aria-labelledby="timebucketsLabel">
  <div class="modal-dialog">
    <div class="modal-content" style="width: 500px;">
    <form method="get" action="#">

      <div class="modal-header">
       <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
       <h4 class="modal-title">{% trans 'time buckets'|capfirst %}</h4>
      </div>
      <div class="modal-body">

      <form method="get" action="#">
      <input type="hidden" name="horizonbuckets" id="horizonbuckets" value="{{request.user.horizonbuckets}}">
      <input type="hidden" name="horizonunit" id="horizonunit" value="{{request.user.horizonunit}}">
      <input id="horizonoriginal" type="hidden" value="{{request.user.horizonbuckets}}|{{request.user.horizonstart|date:"Y-m-d"}}|{{request.user.horizonend|date:"Y-m-d"}}|{{request.user.horizontype}}|{{request.user.horizonlength}}|{{request.user.horizonunit}}"/>
          <div class="row" style="padding-bottom: 15px">
            <div class="col-xs-12">
              {% trans 'bucket size'|capfirst %}&nbsp;&nbsp;
              <div class="dropdown dropdown-submit-input" style="display:inline">
                  <button class="btn btn-default dropdown-toggle" type="button" name="horizonbuckets1" id="horizonbuckets1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    {% if request.user.horizonbuckets %}{% trans request.user.horizonbuckets %}{% endif %}&nbsp;&nbsp;<span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="horizonbuckets1" id="horizonbucketsul" name="horizonbucketsul" style="top: auto;">
                  {% for i in bucketnames %}
                    <li><a onclick="" name="{{ i }}">{% trans i %}</a></li>
                  {% endfor %}
                  </ul>
              </div>
            </div>
          </div>

          <div class="row" style="padding-bottom: 15px">
            <div class="col-xs-12 form-inline">
              <input type="radio" name="horizontype" value="0"{% if not request.user.horizontype %} checked{% endif %}/>
              &nbsp;&nbsp;{% trans 'from'|capfirst %}&nbsp;
              <input id="horizonstart"  style="display:inline" type="text" size="9" class="vDateField form-control" value="{{request.user.horizonstart|date:"Y-m-d"}}"/>
              &nbsp;{% trans 'to' %}&nbsp;
              <input id="horizonend"  style="display:inline" type="text" size="9" class="vDateField form-control" value="{{request.user.horizonend|date:"Y-m-d"}}"/>
              <br/>
           </div>
          </div>

          <div class="row">
            <div class="col-xs-12 form-inline">
              <input type="radio" id="horizontype" name="horizontype" value="1"{% if request.user.horizontype %} checked{% endif %}/>&nbsp;&nbsp;
              <input id="horizonlength" name="horizonlength" type="number" class="form-control" min="1" max="99" maxlength="2" value="{{request.user.horizonlength}}"/>&nbsp;
              <div class="dropdown dropdown-submit-input" style="display:inline">
                <button class="btn btn-default dropdown-toggle form-control" type="button" name="horizonunit1" id="horizonunit1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                  {% if request.user.horizonunit == "day" %}{% trans 'days' %}{% endif %}
                  {% if request.user.horizonunit == "week" %}{% trans 'weeks' %}{% endif %}
                  {% if request.user.horizonunit == "month" %}{% trans 'months' %}{% endif %}
                  &nbsp;&nbsp;<span class="caret"></span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="horizonunit1" id="horizonunitul" name="horizonunitul" style="top: auto;">
                  <li><a name="day">{% trans 'days' %}</a></li>
                  <li><a name="week">{% trans 'weeks' %}</a></li>
                  <li><a name="month">{% trans 'months' %}</a></li>
                </ul>
              </div>
              &nbsp;{% trans 'after plan current date' %}
            </div>
          </div>
      </form>

      </div>
      <div class="modal-footer">
        <input type="submit" id="okbutton" role="button" class="btn btn-primary pull-left" value="{% trans 'OK' %}">
        <input type="submit" id="cancelbutton" role="button" class="btn btn-primary pull-right" data-dismiss="modal" value="{% trans 'cancel'|capfirst %}">
      </div>
    </div>
  </div>
</div>
{% endif %}
{% block contextmenus %}{% endblock %}
{% endblock %}
