{% extends "admin/base_site_nav.html" %}
{% load i18n %}
{% block contextmenus %}
{% include "demandcontext.html" %}
{% include "itemcontext.html" %}
{% include "customercontext.html" %}
{% include "operationcontext.html" %}
{% endblock %}
{% block extrahead %}{{block.super}}
<style type="text/css">
.spacing {
  padding-left: 5px;
  padding-bottom: 5px;
}
#gantt line {
   fill: none;
   stroke: #000;
   shape-rendering: crispEdges;
 }
#gantt .inventoryline {
   stroke: #888888;
   shape-rendering: crispEdges;
 }
</style>
<script type="text/javascript" src="{{STATIC_URL}}js/d3.min.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}planningboard/js/planningboard.js"></script>
<script type="text/javascript">

var horizonstart = new Date(2014,1-1,1);
var horizonend = new Date(2014,7-1,1);
var viewstart = new Date(2014,1-1,1);
var viewend = new Date(2014,7-1,1);
var delta = (viewend.getTime() - viewstart.getTime()) / 86400000.0;

var ganttRows = {}; // Rows configured to be shown.
var numRows = 0;
var colorStyle = 'default';
var critical_red = 5;
var critical_green = 20;
var critical_yellow = (critical_red + critical_green) / 2;
var rowheight = 50;
var timescaleheight = 34;

var x = d3.time.scale().domain([horizonstart, horizonend]);
var y = d3.scale.linear().rangeRound([rowheight-3, 3]);

var service_url = ('https:' == document.location.protocol ? 'wss://' : 'ws://') + document.location.hostname
  + ':{{port}}/planningboard/?username={{request.user.username|urlencode}}&userid={{request.user.id}}&time={{time}}&token={{token}}';

$(function() {
  $(".fa-lg").tooltip({show: {effect: "fade", delay: 500}});
  $("#ganttdiv").resizable({
    handles:"s",
    maxHeight: ganttRows.length * rowheight,
    minHeight: 2 * rowheight + 10
    });
  $("#tabs").tabs();
  $("#chatsend").button();
  timeAxis = d3.select("#gantt").append("g").attr("transform", "translate(250,0)");
  drawAxis();
  connect(service_url, function() {
    send("/get/");
    var initialrows = {{preferences|safe}};
    for (var idx = 0; idx < initialrows.length; idx++)
      send("/register/" + initialrows[idx]);
    for (var idx = 0; idx < initialrows.length; idx++)
    {
      if (!(initialrows[idx] in ganttRows))
      {
        ganttRows[initialrows[idx]] = {
           "index": numRows++,
           "svg": null,
           "data": null,
           "type": initialrows[idx].slice(0, initialrows[idx].indexOf("/"))
           };
        send("/plan/" + initialrows[idx]);
      }
    }
  });
});

</script>
{% endblock %}
{% block content %}
<div id="toolicons">
<span onclick="gantt.zoom(0.5,0)" class="fa fa-search-plus fa-lg" title="{% trans 'Zoom in'|escape %}"></span>&nbsp;&nbsp;
<span onclick="gantt.zoom(1.5,0)" class="fa fa-search-minus fa-lg" title="{% trans 'Zoom out'|escape %}"></span>&nbsp;&nbsp;
<span onclick="gantt.zoom(1,-86400000)" class="fa fa-backward fa-lg" title="{% trans 'Move in'|escape %}"></span>&nbsp;&nbsp;
<span onclick="gantt.zoom(1,86400000)" class="fa fa-forward fa-lg" title="{% trans 'Move out'|escape %}"></span>&nbsp;&nbsp;
<span onclick="resetBoard()" class="fa fa-square fa-lg" title="{% trans 'Reset'|escape %}"></span>&nbsp;&nbsp;
<span onclick="grid.showBucket()" title="{% trans 'Configure time buckets'|escape %}" id="bucketconfig" class="fa fa-clock-o fa-lg"></span>
</div>
<div id="content-main" style="width:100%; border: 1px solid; border-radius: 10px">
<div id="ganttdiv" style="margin: 5px 1px 5px 0px; overflow-x: hide; overflow-y: scroll"><svg id="gantt"></svg></div>
</div>

<div id="tabs" style="width:100%; margin-top:10px">
  <ul>
    <li><a href="#demand">{% trans "Demand" %}</a></li>
    <li><a href="#resource">{% trans "Resource" %}</a></li>
    <li><a href="#buffer">{% trans "Buffer" %}</a></li>
    <li><a href="#operation">{% trans "Operation" %}</a></li>
    <li><a href="#supplier">{% trans "Supplier" %}</a></li>
    <li><a href="#chat">{% trans "Messages" %}</a></li>
    <li><a href="#chart">{% trans "Chart" %}</a></li>
  </ul>
  <div id="demand">
    <div style="float: right">
    <span onclick="actionSelectedDemand('/solve/erase/', '/solve/unplan/')" title="{% trans 'Clear the plan of selected demands'|escape %}" class="fa fa-stop fa-lg spacing"></span>
    <span onclick="actionSelectedDemand('/solve/replan/backward/', '/solve/demand/backward/')" title="{% trans 'Plan selected demands backward from their due date'|escape %}" class="fa fa-fast-backward fa-lg spacing"></span>
    <span onclick="actionSelectedDemand('/solve/replan/forward/', '/solve/demand/forward/')" title="{% trans 'Plan selected demands forward from the current date'|escape %}" class="fa fa-fast-forward fa-lg spacing"></span>
    <span onclick="addSelected('demand')" title="{% trans 'Add to the graph'|escape %}" class="fa fa-tasks fa-lg"></span>
    </div>
    <div class="clear"><table id="demandlist"></table></div>
  </div>
  <div id="resource">
    <div style="float: right">
    <span onclick="addSelected('resource')" title="{% trans 'Add to the graph'|escape %}" class="fa fa-tasks fa-lg spacing"></span>
    </div>
    <div class="clear"><table id="resourcelist"></table></div>
  </div>
  <div id="buffer">
    <div style="float: right">
    <span onclick="addSelected('buffer')" title="{% trans 'Add to the graph'|escape %}" class="fa fa-tasks fa-lg spacing"></span>
    </div>
    <div class="clear"><table id="bufferlist"></table></div>
  </div>
  <div id="operation">
    <div style="float: right">
    <span onclick="addSelected('operation')" title="{% trans 'Add to the graph'|escape %}" class="fa fa-tasks fa-lg spacing"></span>
    </div>
    <div class="clear"><table id="operationlist"></table></div>
  </div>
  <div id="supplier">
    <div style="float: right">
    <span onclick="addSelected('supplier')" title="{% trans 'Add to the graph'|escape %}" class="fa fa-tasks fa-lg spacing"></span>
    </div>
    <div class="clear"><table id="supplierlist"></table></div>
  </div>
  <div id="chat">
    <div style="width: 100%; height: 200px; overflow-y: scroll"><table id="chathistory"></table></div>
    <input id="chatsend" onclick="sendChat()" type="button" value="{% trans "Send" %}">
    <input id="chatmsg" type="text" size="40">
  </div>
  <div id="chart">
    Color by:<br/>
    <input id="color_default" type="radio" name="chartcolor" value="default" onclick="colorBoard('default')" checked><label for="color_default">Default</label><br/>
    <input id="color_criticality" type="radio" name="chartcolor" onclick="colorBoard('criticality')" value="criticality"><label for="color_criticality">Criticality</label>
    <input id="color_critical_red" type="number" step="1" min="0" max="100" size="3" value="5" onchange="colorBoard('criticality')"/>
    <input id="color_critical_green" type="number" step="1" min="0" max="100" size="3" value="20" onchange="colorBoard('criticality')"/><br/>
  </div>
</div>

<div id="timebuckets" style="display:none" title="{% trans 'Time buckets' %}">
<form method="get" action="">
{% trans 'Bucket size' %}&nbsp;&nbsp;<select name="horizonbuckets" id="horizonbuckets">
{% for i in bucketnames %}<option value="{{i}}"{% ifequal i request.user.horizonbuckets %} selected="selected"{% endifequal %}>{% trans i %}</option>
{% endfor %}</select><br/>
<input type="radio" name="horizontype" value="0"{% if not request.user.horizontype %} checked{% endif %}/>&nbsp;&nbsp;
{% trans 'from'|capfirst %}&nbsp;
<input id="horizonstart" type="text" size="9" class="vDateField" value="{{request.user.horizonstart|date:"Y-m-d"}}"/>
{% trans 'to' %}&nbsp;
<input id="horizonend" type="text" size="9" class="vDateField" value="{{request.user.horizonend|date:"Y-m-d"}}"/><br/>
<input type="radio" id="horizontype" name="horizontype" value="1"{% if request.user.horizontype %} checked{% endif %}/>&nbsp;&nbsp;
<input id="horizonlength" name="horizonlength" type="text" size="2" value="{{request.user.horizonlength}}"/>&nbsp;
<select name="horizonunit" id="horizonunit">
<option value="day"{% ifequal request.user.horizonunit 'day' %} selected="selected"{% endifequal %}>{% trans 'days' %}</option>
<option value="week"{% ifequal request.user.horizonunit 'week' %} selected="selected"{% endifequal %}>{% trans 'weeks' %}</option>
<option value="month"{% ifequal request.user.horizonunit 'month' %} selected="selected"{% endifequal %}>{% trans 'months' %}</option>
</select>&nbsp;{% trans 'after plan current date' %}
<input id="horizonoriginal" type="hidden" value="{{request.user.horizonbuckets}}|{{request.user.horizonstart|date:"Y-m-d"}}|{{request.user.horizonend|date:"Y-m-d"}}|{{request.user.horizontype}}|{{request.user.horizonlength}}|{{request.user.horizonunit}}"/>
</form>
</div>


{% endblock %}