<?xml version="1.0" encoding="UTF-8" ?>
<plan xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <name>Forecast matching test model</name>
  <description>
    This test case test the matching between an actual order and a forecast.
    Different scenarios are being validated:
      - A: match at 'customer'+'item' level
      - B: match at 'item' level
      - C: match at 'parent customer' + 'item' level
      - D: match at 'customer' + 'parent item' level
      - E: match at 'parent customer' + 'parent item' level
  </description>
  <current>2009-01-01T00:00:00</current>  
  <calendars>
    <calendar name="Months">
      <buckets>
        <bucket start="2009-01-01T00:00:00" end="2009-02-01T00:00:00" value="1"/>
        <bucket start="2009-02-01T00:00:00" end="2009-03-01T00:00:00" value="1"/>
        <bucket start="2009-03-01T00:00:00" end="2009-04-01T00:00:00" value="1"/>
      </buckets>
    </calendar>
  </calendars>

  <!-- Define a hierarchical tree of customers:
    "grandparent customer"   -> "parent customer" -> "customer"
  -->
  <customers>
    <customer name="A parent customer">
      <owner name="A grandparent customer" />
      <members>
         <customer name="A customer"/>
      </members>
    </customer>
    <customer name="B parent customer">
      <owner name="B grandparent customer" />
      <members>
         <customer name="B customer"/>
      </members>
    </customer>
    <customer name="C parent customer">
      <owner name="C grandparent customer" />
      <members>
         <customer name="C customer"/>
      </members>
    </customer>
    <customer name="D parent customer">
      <owner name="D grandparent customer" />
      <members>
         <customer name="D customer"/>
      </members>
    </customer>
    <customer name="E parent customer">
      <owner name="E grandparent customer" />
      <members>
         <customer name="E customer"/>
      </members>
    </customer>
  </customers>

  <!-- Define a hierarchical tree of items:
    "grandparent item"   -> "parent item" -> "item"
  -->
  <items>
    <item name="A parent item">
      <owner name="A grandparent item" />
      <members>
         <item name="A item">
            <operation name="A delivery" xsi:type="operation_fixed_time">
              <duration>P1D</duration>
            </operation>
         </item>
      </members>
    </item>
    <item name="B parent item">
      <owner name="B grandparent item" />
      <members>
         <item name="B item">
            <operation name="B delivery" xsi:type="operation_fixed_time">
              <duration>P1D</duration>
            </operation>
         </item>
      </members>
    </item>
    <item name="C parent item">
      <owner name="C grandparent item" />
      <members>
         <item name="C item">
            <operation name="C delivery" xsi:type="operation_fixed_time">
              <duration>P1D</duration>
            </operation>
         </item>
      </members>
    </item>
    <item name="D parent item">
      <owner name="D grandparent item" />
      <members>
         <item name="D item">
            <operation name="D delivery" xsi:type="operation_fixed_time">
              <duration>P1D</duration>
            </operation>
         </item>
      </members>
    </item>
    <item name="E parent item">
      <owner name="E grandparent item" />
      <members>
         <item name="E item">
            <operation name="E delivery" xsi:type="operation_fixed_time">
              <duration>P1D</duration>
            </operation>
         </item>
      </members>
    </item>
  </items>

  <!-- Case A: Match at 'customer' and 'item' level. -->
  <demands>
    <!-- Forecasts -->
    <demand name="A forecast" xsi:type="demand_forecast">
      <item name="A item" />
      <customer name="A customer" />
      <calendar name="Months" />
      <buckets>
        <bucket>
          <start>2009-01-01T00:00:00</start>
          <end>2009-02-01T00:00:00</end>
          <total>100</total>
        </bucket>
      </buckets>
    </demand>
    <demand name="A forecast not selected" xsi:type="demand_forecast">
      <description>This forecast is not selected because lower level
      matches take precedence.</description>
      <item name="A parent item" />
      <customer name="A parent customer" />
      <calendar name="Months" />
    </demand>
    <!-- Actual orders -->
    <demand name="A order">
      <item name="A item"/>
      <customer name="A customer"/>
      <quantity>10</quantity>
      <due>2009-01-02T00:00:00</due>
    </demand>
  </demands>

  <!-- Case B: Match at 'item' level. -->
  <demands>
    <!-- Forecasts -->
    <demand name="B forecast" xsi:type="demand_forecast">
      <item name="B item" />
      <calendar name="Months" />
      <buckets>
        <bucket>
          <start>2009-01-01T00:00:00</start>
          <end>2009-02-01T00:00:00</end>
          <total>100</total>
        </bucket>
      </buckets>
    </demand>
    <!-- Actual orders -->
    <demand name="B order 1">
      <item name="B item"/>
      <customer name="B customer"/>
      <quantity>10</quantity>
      <due>2009-01-02T00:00:00</due>
    </demand>
    <demand name="B order 2">
      <item name="B item"/>
      <quantity>10</quantity>
      <due>2009-01-02T00:00:00</due>
    </demand>
  </demands>

  <!-- Case C: Match at 'parent customer' + 'item' level. -->
  <demands>
    <!-- Forecasts -->
    <demand name="C forecast" xsi:type="demand_forecast">
      <item name="C item" />
      <customer name="C parent customer" />
      <calendar name="Months" />
      <buckets>
        <bucket>
          <start>2009-01-01T00:00:00</start>
          <end>2009-02-01T00:00:00</end>
          <total>100</total>
        </bucket>
      </buckets>
    </demand>
    <demand name="C forecast not selected" xsi:type="demand_forecast">
      <description>This forecast is not selected since we search higher
      levels in the customer dimension first.
      Switching the flag Customer_Then_Item_Hierarchy to false will
      flip the search order around.</description>
      <item name="C parent item" />
      <customer name="C customer" />
      <calendar name="Months" />
      <buckets>
        <bucket>
          <start>2009-01-01T00:00:00</start>
          <end>2009-02-01T00:00:00</end>
          <total>100</total>
        </bucket>
      </buckets>
    </demand>
    <!-- Actual orders -->
    <demand name="C order">
      <item name="C item"/>
      <customer name="C customer"/>
      <quantity>10</quantity>
      <due>2009-01-02T00:00:00</due>
    </demand>
  </demands>

  <!-- Case D: Match at 'customer' + 'parent item' level. -->
  <demands>
    <!-- Forecasts -->
    <demand name="D forecast" xsi:type="demand_forecast">
      <item name="D parent item" />
      <customer name="D customer" />
      <calendar name="Months" />
      <buckets>
        <bucket>
          <start>2009-01-01T00:00:00</start>
          <end>2009-02-01T00:00:00</end>
          <total>100</total>
        </bucket>
      </buckets>
    </demand>
    <!-- Actual orders -->
    <demand name="D order">
      <item name="D item"/>
      <customer name="D customer"/>
      <quantity>10</quantity>
      <due>2009-01-02T00:00:00</due>
    </demand>
  </demands>

  <!-- Case E: Match at 'parent customer' + 'parent item' level. -->
  <demands>
    <!-- Forecasts -->
    <demand name="E forecast" xsi:type="demand_forecast">
      <item name="E parent item" />
      <customer name="E parent customer" />
      <calendar name="Months" />
      <buckets>
        <bucket>
          <start>2009-01-01T00:00:00</start>
          <end>2009-02-01T00:00:00</end>
          <total>100</total>
        </bucket>
      </buckets>
    </demand>
    <!-- Actual orders -->
    <demand name="E order">
      <item name="E item"/>
      <customer name="E customer"/>
      <quantity>10</quantity>
      <due>2009-01-02T00:00:00</due>
    </demand>
  </demands>

<?python
frepple.solver_forecast(name="Netting orders from forecast",loglevel=2).solve()
frepple.saveXMLfile("output.1.xml")
?>

</plan>
